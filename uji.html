<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Pembelajaran Interaktif SMP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: #10b981;
        }
        .notification.error {
            background-color: #ef4444;
        }
        .notification.info {
            background-color: #3b82f6;
        }
        .notification.warning {
            background-color: #f59e0b;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
 </head>
 <body class="h-full bg-gray-50">
  <script>
        // Configuration
        const defaultConfig = {
            school_name: "SMP Negeri 1 Indonesia",
            school_vision: "Mewujudkan Generasi Cerdas, Berkarakter, dan Berdaya Saing Global",
            welcome_message: "Selamat datang di portal pembelajaran digital yang inovatif",
            footer_message: "Merdeka Belajar - Indonesia Maju 2045",
            primary_color: "#3b82f6",
            secondary_color: "#10b981",
            accent_color: "#f59e0b",
            text_color: "#1f2937",
            background_color: "#f9fafb"
        };

        // Google Sheets Configuration
        const SHEET_CONFIG = {
            SHEET_ID: '12damNTphrDElg1qsmAWVKoTrfXhDXKa8l660vhTNR8I', // ID Google Sheets Anda
            STUDENTS_SHEET: 'DataSiswa',
            TEACHERS_SHEET: 'DataGuru', 
            MATERIALS_SHEET: 'MateriPelajaran',
            LKPD_SHEET: 'LKPD',
            PROGRESS_SHEET: 'ProgressSiswa'
        };

        // Sheet column mappings untuk memastikan kompatibilitas
        const SHEET_COLUMNS = {
            DataSiswa: ['NISN', 'Nama', 'Kelas'],
            DataGuru: ['NIP', 'Nama', 'Mata Pelajaran', 'Email'],
            MateriPelajaran: ['ID', 'Judul', 'Deskripsi', 'Mata Pelajaran', 'Kelas', 'Tipe', 'Link'],
            LKPD: ['ID', 'Judul', 'Mata Pelajaran', 'Kelas', 'Link', 'Deskripsi'],
            ProgressSiswa: ['NISN', 'Nama', 'Kelas', 'Mata Pelajaran', 'Materi/LKPD', 'Jenis', 'Waktu']
        };

        // Global State
        let currentUser = null;
        let studentsData = [];
        let teachersData = [];
        let materialsData = [];
        let lkpdData = [];
        let progressData = [];
        let isLoading = false;
        let currentRecordCount = 0;

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                progressData = data;
                currentRecordCount = data.length;
                updateProgressDisplay();
            }
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function showLoading(show = true) {
            isLoading = show;
            const loadingElements = document.querySelectorAll('.loading-indicator');
            loadingElements.forEach(el => {
                el.style.display = show ? 'flex' : 'none';
            });
        }

        async function fetchGoogleSheetData(sheetName) {
            try {
                console.log(`üîÑ Memulai fetch untuk sheet: ${sheetName}`);
                
                // Coba beberapa format URL yang berbeda dengan encoding yang tepat
                const encodedSheetName = encodeURIComponent(sheetName);
                const urls = [
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodedSheetName}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${encodedSheetName}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${sheetName}`,
                    // Tambahan untuk sheet dengan nama khusus
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=0&range=${sheetName}!A:Z`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&range=${sheetName}!A1:Z1000`
                ];

                let lastError = null;
                let attemptCount = 0;
                
                for (const url of urls) {
                    attemptCount++;
                    try {
                        console.log(`üì° Percobaan ${attemptCount}: ${url}`);
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json, text/plain, */*',
                                'Cache-Control': 'no-cache'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const text = await response.text();
                        console.log(`üìÑ Response length untuk ${sheetName}:`, text.length);
                        
                        if (text.length < 50) {
                            throw new Error('Response terlalu pendek, kemungkinan sheet tidak ditemukan');
                        }
                        
                        // Handle different response formats dengan lebih robust
                        let jsonText = text;
                        
                        // Format 1: /*O_o*/\ngoogle.visualization.Query.setResponse(...)
                        if (text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) {
                            jsonText = text.substring(47, text.length - 2);
                        }
                        // Format 2: google.visualization.Query.setResponse(...)
                        else if (text.includes('google.visualization.Query.setResponse(')) {
                            const start = text.indexOf('google.visualization.Query.setResponse(') + 39;
                            const end = text.lastIndexOf(');');
                            if (end > start) {
                                jsonText = text.substring(start, end);
                            }
                        }
                        // Format 3: Direct JSON
                        else if (text.trim().startsWith('{')) {
                            jsonText = text;
                        }
                        
                        const json = JSON.parse(jsonText);
                        console.log(`üîç Parsed JSON structure untuk ${sheetName}:`, {
                            hasTable: !!json.table,
                            hasRows: !!(json.table && json.table.rows),
                            rowCount: json.table && json.table.rows ? json.table.rows.length : 0,
                            hasColumns: !!(json.table && json.table.cols),
                            colCount: json.table && json.table.cols ? json.table.cols.length : 0
                        });
                        
                        // Cek apakah ada error dalam response
                        if (json.status === 'error') {
                            throw new Error(`Google Sheets API Error: ${json.errors?.[0]?.detailed_message || 'Unknown error'}`);
                        }
                        
                        if (!json.table) {
                            throw new Error('Tidak ada data table dalam response');
                        }
                        
                        if (!json.table.rows || json.table.rows.length === 0) {
                            console.warn(`‚ö†Ô∏è Sheet ${sheetName} kosong atau tidak ada data`);
                            // Jangan langsung continue, return empty array untuk sheet kosong
                            return [];
                        }
                        
                        if (!json.table.cols || json.table.cols.length === 0) {
                            throw new Error('Tidak ada kolom yang ditemukan');
                        }
                        
                        const headers = json.table.cols.map(col => {
                            return col.label || col.id || `Column_${col.index || 0}`;
                        });
                        
                        console.log(`üìã Headers untuk ${sheetName}:`, headers);
                        
                        const data = json.table.rows.map((row, rowIndex) => {
                            const obj = {};
                            headers.forEach((header, colIndex) => {
                                const cell = row.c && row.c[colIndex];
                                let value = '';
                                
                                if (cell) {
                                    // Prioritas: formatted value, lalu value, lalu empty string
                                    value = cell.f || cell.v || '';
                                    
                                    // Convert to string dan trim
                                    if (value !== null && value !== undefined) {
                                        value = value.toString().trim();
                                    }
                                }
                                
                                obj[header] = value;
                            });
                            return obj;
                        }).filter((row, index) => {
                            // Filter out completely empty rows
                            const hasData = Object.values(row).some(value => 
                                value && value.toString().trim() !== ''
                            );
                            
                            if (!hasData) {
                                console.log(`üóëÔ∏è Filtering out empty row ${index} in ${sheetName}`);
                            }
                            
                            return hasData;
                        });
                        
                        console.log(`‚úÖ Berhasil memuat ${sheetName}: ${data.length} records`);
                        console.log(`üìä Sample data untuk ${sheetName}:`, data.slice(0, 2));
                        
                        return data;
                        
                    } catch (error) {
                        lastError = error;
                        console.warn(`‚ùå Percobaan ${attemptCount} gagal untuk ${sheetName}:`, error.message);
                        
                        // Jika ini percobaan terakhir, log detail error
                        if (attemptCount === urls.length) {
                            console.error(`üö® Semua percobaan gagal untuk ${sheetName}:`, error);
                        }
                        continue;
                    }
                }
                
                throw lastError || new Error(`Semua ${urls.length} percobaan URL gagal untuk sheet ${sheetName}`);
                
            } catch (error) {
                console.error(`üí• Fatal error fetching ${sheetName}:`, error);
                showNotification(`Gagal memuat ${sheetName}: ${error.message}`, 'error');
                return [];
            }
        }

        async function loadAllData() {
            showLoading(true);
            try {
                const [students, teachers, materials, lkpd] = await Promise.all([
                    fetchGoogleSheetData(SHEET_CONFIG.STUDENTS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.TEACHERS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.MATERIALS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.LKPD_SHEET)
                ]);
                
                studentsData = students;
                teachersData = teachers;
                materialsData = materials;
                lkpdData = lkpd;
                
                showNotification('Data berhasil dimuat dari Google Sheets');
            } catch (error) {
                showNotification('Gagal memuat data dari Google Sheets', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveProgress(progressData) {
            if (currentRecordCount >= 999) {
                showNotification('Batas maksimum 999 record tercapai. Hubungi administrator.', 'error');
                return;
            }

            showLoading(true);
            try {
                // Simpan ke Data SDK (Canva Sheet internal)
                const result = await window.dataSdk.create({
                    student_id: progressData.student_id,
                    student_name: progressData.student_name,
                    class_grade: progressData.class_grade,
                    subject: progressData.subject,
                    material_id: progressData.material_id,
                    material_title: progressData.material_title,
                    progress_type: progressData.progress_type,
                    progress_value: progressData.progress_value,
                    session_duration: progressData.session_duration || 0,
                    timestamp: new Date().toISOString()
                });

                if (result.isOk) {
                    // Juga coba kirim ke Google Sheets ProgressSiswa (opsional)
                    await saveToGoogleSheetProgress(progressData);
                    showNotification('Progress berhasil disimpan');
                } else {
                    showNotification('Gagal menyimpan progress', 'error');
                }
            } catch (error) {
                showNotification('Error menyimpan progress', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveToGoogleSheetProgress(progressData) {
            try {
                // Format data untuk Google Sheets
                const timestamp = new Date().toLocaleString('id-ID', {
                    timeZone: 'Asia/Jakarta',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const jenisAktivitas = progressData.progress_type === 'material_access' ? 'Akses Materi' : 'Mengerjakan LKPD';
                
                // Buat URL untuk Google Apps Script (jika tersedia)
                // Ini adalah contoh implementasi - perlu Google Apps Script di sisi server
                const formData = new FormData();
                formData.append('nisn', progressData.student_id);
                formData.append('nama', progressData.student_name);
                formData.append('kelas', progressData.class_grade);
                formData.append('mataPelajaran', progressData.subject);
                formData.append('materiLKPD', progressData.material_title);
                formData.append('jenis', jenisAktivitas);
                formData.append('waktu', timestamp);

                // Catatan: URL ini perlu diganti dengan Google Apps Script yang sebenarnya
                // const scriptUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
                // const response = await fetch(scriptUrl, {
                //     method: 'POST',
                //     body: formData
                // });

                console.log('üìù Data progress yang akan disimpan ke Google Sheets:', {
                    NISN: progressData.student_id,
                    Nama: progressData.student_name,
                    Kelas: progressData.class_grade,
                    'Mata Pelajaran': progressData.subject,
                    'Materi/LKPD': progressData.material_title,
                    Jenis: jenisAktivitas,
                    Waktu: timestamp
                });

            } catch (error) {
                console.warn('Gagal menyimpan ke Google Sheets (opsional):', error);
                // Tidak menampilkan error ke user karena ini opsional
            }
        }

        // Authentication Functions
        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userType = formData.get('userType');
            const identifier = formData.get('identifier');

            // Validasi input
            if (!userType) {
                showNotification('Pilih jenis pengguna terlebih dahulu!', 'error');
                return;
            }

            if (!identifier || identifier.trim() === '') {
                showNotification('Masukkan ID pengguna!', 'error');
                return;
            }

            showLoading(true);

            try {
                // Cek apakah data sudah dimuat
                if (userType === 'student' && studentsData.length === 0) {
                    showNotification('Data siswa belum dimuat. Coba refresh halaman.', 'error');
                    showLoading(false);
                    return;
                }

                if (userType === 'teacher' && teachersData.length === 0) {
                    showNotification('Data guru belum dimuat. Coba refresh halaman.', 'error');
                    showLoading(false);
                    return;
                }

                let user = null;
                let errorMessage = '';
                
                console.log(`üîç Mencari ${userType} dengan ID: "${identifier}"`);
                
                if (userType === 'student') {
                    console.log(`üë• Data siswa tersedia:`, studentsData.length, 'records');
                    console.log(`üìã Sample data siswa:`, studentsData.slice(0, 3));
                    
                    // Cari dengan berbagai kemungkinan field name dan format
                    user = studentsData.find(s => {
                        const nisn = s.NISN || s.nisn || s.Nisn || s['NISN'] || '';
                        return nisn && nisn.toString().trim() === identifier.toString().trim();
                    });
                    
                    if (user) {
                        user.type = 'student';
                        user.id = user.NISN || user.nisn || user.Nisn || user['NISN'];
                        user.name = user.Nama || user.nama || user.Name || user['Nama'];
                        user.class = user.Kelas || user.kelas || user.Class || user['Kelas'];
                        console.log(`‚úÖ Siswa ditemukan:`, user);
                    } else {
                        // Cek apakah ada data siswa yang mirip
                        const similarStudents = studentsData.filter(s => {
                            const nisn = s.NISN || s.nisn || s.Nisn || s['NISN'] || '';
                            return nisn && nisn.toString().includes(identifier);
                        });
                        
                        console.log(`üîç Siswa dengan ID mirip:`, similarStudents);
                        
                        if (similarStudents.length > 0) {
                            const suggestions = similarStudents.slice(0, 3).map(s => 
                                s.NISN || s.nisn || s.Nisn || s['NISN']
                            ).join(', ');
                            errorMessage = `NISN "${identifier}" tidak ditemukan. Mungkin maksud Anda: ${suggestions}`;
                        } else {
                            const availableNISNs = studentsData.map(s => s.NISN || s.nisn || s.Nisn || s['NISN']).filter(Boolean);
                            if (availableNISNs.length > 0) {
                                const suggestions = availableNISNs.slice(0, 3).join(', ');
                                errorMessage = `NISN "${identifier}" tidak terdaftar. Contoh NISN yang tersedia: ${suggestions}`;
                            } else {
                                errorMessage = `NISN "${identifier}" tidak terdaftar. Pastikan NISN sudah benar dan terdaftar di Google Sheets.`;
                            }
                        }
                        
                        // Debug info untuk troubleshooting
                        console.log(`‚ùå NISN tidak ditemukan. Available NISNs:`, 
                            studentsData.map(s => s.NISN || s.nisn || s.Nisn || s['NISN']).filter(Boolean)
                        );
                    }
                } else if (userType === 'teacher') {
                    console.log(`üë®‚Äçüè´ Data guru tersedia:`, teachersData.length, 'records');
                    console.log(`üìã Sample data guru:`, teachersData.slice(0, 3));
                    console.log(`üîç Struktur kolom guru:`, teachersData.length > 0 ? Object.keys(teachersData[0]) : 'Tidak ada data');
                    
                    // Cari dengan berbagai kemungkinan field name dan format - sesuai dengan kolom yang disebutkan
                    user = teachersData.find(t => {
                        // Sesuai dengan kolom: NIP, Nama, Mata Pelajaran, Email
                        // Coba berbagai variasi nama kolom
                        const nipFields = ['NIP', 'nip', 'Nip', 'NIP ', ' NIP', 'NIP.', '.NIP'];
                        let nip = '';
                        
                        // Cari field NIP yang ada
                        for (const field of nipFields) {
                            if (t[field] !== undefined && t[field] !== null && t[field] !== '') {
                                nip = t[field].toString().trim();
                                break;
                            }
                        }
                        
                        // Jika tidak ada field NIP yang jelas, coba cari di semua field
                        if (!nip) {
                            const allKeys = Object.keys(t);
                            for (const key of allKeys) {
                                if (key.toLowerCase().includes('nip') && t[key] && t[key].toString().trim() !== '') {
                                    nip = t[key].toString().trim();
                                    console.log(`üîç Found NIP in field "${key}": ${nip}`);
                                    break;
                                }
                            }
                        }
                        
                        if (!nip) {
                            console.log(`‚ö†Ô∏è No NIP found for teacher:`, t);
                            return false;
                        }
                        
                        const inputNip = identifier.toString().trim();
                        
                        // Normalisasi NIP - hapus spasi, titik, dan tanda hubung
                        const normalizedNip = nip.replace(/[\s\-\.\,]/g, '');
                        const normalizedInput = inputNip.replace(/[\s\-\.\,]/g, '');
                        
                        // Multiple matching strategies
                        const exactMatch = normalizedNip === normalizedInput;
                        const originalMatch = nip === inputNip;
                        const containsMatch = normalizedNip.includes(normalizedInput) && normalizedInput.length >= 3;
                        const reverseContainsMatch = normalizedInput.includes(normalizedNip) && normalizedNip.length >= 3;
                        
                        const result = exactMatch || originalMatch || containsMatch || reverseContainsMatch;
                        
                        console.log(`üîç Checking teacher NIP: "${nip}" (normalized: "${normalizedNip}") vs "${inputNip}" (normalized: "${normalizedInput}")`, {
                            exactMatch,
                            originalMatch,
                            containsMatch,
                            reverseContainsMatch,
                            finalResult: result
                        });
                        
                        return result;
                    });
                    
                    if (user) {
                        user.type = 'teacher';
                        
                        // Cari NIP dengan berbagai variasi
                        const nipFields = ['NIP', 'nip', 'Nip', 'NIP ', ' NIP', 'NIP.', '.NIP'];
                        for (const field of nipFields) {
                            if (user[field] !== undefined && user[field] !== null && user[field] !== '') {
                                user.id = user[field].toString().trim();
                                break;
                            }
                        }
                        
                        // Cari Nama dengan berbagai variasi
                        const namaFields = ['Nama', 'nama', 'Name', 'name', 'Nama ', ' Nama'];
                        for (const field of namaFields) {
                            if (user[field] !== undefined && user[field] !== null && user[field] !== '') {
                                user.name = user[field].toString().trim();
                                break;
                            }
                        }
                        
                        // Cari Mata Pelajaran dengan berbagai variasi
                        const mapelFields = ['Mata Pelajaran', 'mata_pelajaran', 'MataPelajaran', 'Subject', 'subject', 'Mapel', 'mapel'];
                        for (const field of mapelFields) {
                            if (user[field] !== undefined && user[field] !== null && user[field] !== '') {
                                user.subject = user[field].toString().trim();
                                break;
                            }
                        }
                        
                        // Cari Email dengan berbagai variasi
                        const emailFields = ['Email', 'email', 'EMAIL', 'Email ', ' Email'];
                        for (const field of emailFields) {
                            if (user[field] !== undefined && user[field] !== null && user[field] !== '') {
                                user.email = user[field].toString().trim();
                                break;
                            }
                        }
                        
                        // Set default values jika tidak ditemukan
                        user.id = user.id || 'N/A';
                        user.name = user.name || 'Guru';
                        user.subject = user.subject || 'Umum';
                        user.email = user.email || '';
                        
                        console.log(`‚úÖ Guru ditemukan:`, {
                            id: user.id,
                            name: user.name,
                            subject: user.subject,
                            email: user.email,
                            originalData: user
                        });
                    } else {
                        // Debug: tampilkan semua NIP yang tersedia dengan berbagai field
                        const availableNIPs = [];
                        teachersData.forEach((t, index) => {
                            const nipFields = ['NIP', 'nip', 'Nip', 'NIP ', ' NIP', 'NIP.', '.NIP'];
                            let foundNip = '';
                            
                            for (const field of nipFields) {
                                if (t[field] !== undefined && t[field] !== null && t[field] !== '') {
                                    foundNip = t[field].toString().trim();
                                    break;
                                }
                            }
                            
                            if (!foundNip) {
                                // Cari di semua field yang mengandung 'nip'
                                const allKeys = Object.keys(t);
                                for (const key of allKeys) {
                                    if (key.toLowerCase().includes('nip') && t[key] && t[key].toString().trim() !== '') {
                                        foundNip = t[key].toString().trim();
                                        break;
                                    }
                                }
                            }
                            
                            if (foundNip) {
                                availableNIPs.push(foundNip);
                            } else {
                                console.warn(`‚ö†Ô∏è Teacher ${index + 1} tidak memiliki NIP yang valid:`, t);
                            }
                        });
                        
                        console.log(`‚ùå NIP tidak ditemukan. Available NIPs:`, availableNIPs);
                        
                        // Cek apakah ada data guru yang mirip
                        const similarTeachers = teachersData.filter(t => {
                            const allValues = Object.values(t).join(' ').toLowerCase();
                            return allValues.includes(identifier.toLowerCase());
                        });
                        
                        console.log(`üîç Guru dengan data mirip:`, similarTeachers);
                        
                        if (similarTeachers.length > 0) {
                            const suggestions = similarTeachers.slice(0, 3).map(t => {
                                const nipFields = ['NIP', 'nip', 'Nip'];
                                for (const field of nipFields) {
                                    if (t[field]) return t[field];
                                }
                                return 'NIP tidak ditemukan';
                            }).join(', ');
                            errorMessage = `NIP "${identifier}" tidak ditemukan. Data mirip ditemukan: ${suggestions}`;
                        } else if (availableNIPs.length > 0) {
                            const suggestions = availableNIPs.slice(0, 3).join(', ');
                            errorMessage = `NIP "${identifier}" tidak terdaftar. Contoh NIP yang tersedia: ${suggestions}`;
                        } else {
                            errorMessage = `NIP "${identifier}" tidak terdaftar. Pastikan NIP sudah benar dan terdaftar di Google Sheets dengan kolom NIP, Nama, Mata Pelajaran, Email.`;
                        }
                        
                        // Tampilkan struktur data guru untuk debugging
                        if (teachersData.length > 0) {
                            console.log(`üîç Struktur data guru pertama:`, teachersData[0]);
                            console.log(`üîç Semua field yang tersedia:`, Object.keys(teachersData[0]));
                        }
                    }
                }

                if (user) {
                    currentUser = user;
                    showDashboard();
                    showNotification(`Selamat datang, ${user.name}!`);
                } else {
                    showNotification(errorMessage, 'error');
                    showLoginHelp();
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Terjadi kesalahan saat login. Coba lagi dalam beberapa saat.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showLoginHelp() {
            const helpDiv = document.getElementById('login-help');
            if (helpDiv) {
                helpDiv.classList.remove('hidden');
                setTimeout(() => {
                    helpDiv.classList.add('hidden');
                }, 10000); // Hide after 10 seconds
            }
        }

        function showDebugInfo() {
            const debugModal = document.createElement('div');
            debugModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            debugModal.innerHTML = `
                <div class="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">üîç Debug Info - Analisis Koneksi Google Sheets</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Status Koneksi -->
                        <div class="p-4 border rounded-lg">
                            <h4 class="font-semibold text-blue-600 mb-2">üìä Status Koneksi Google Sheets</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="text-center p-2 rounded ${studentsData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${studentsData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>DataSiswa</div>
                                    <div class="text-xs">${studentsData.length} records</div>
                                </div>
                                <div class="text-center p-2 rounded ${teachersData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${teachersData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>DataGuru</div>
                                    <div class="text-xs">${teachersData.length} records</div>
                                </div>
                                <div class="text-center p-2 rounded ${materialsData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${materialsData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>MateriPelajaran</div>
                                    <div class="text-xs">${materialsData.length} records</div>
                                </div>
                                <div class="text-center p-2 rounded ${lkpdData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${lkpdData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>LKPD</div>
                                    <div class="text-xs">${lkpdData.length} records</div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Siswa -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üë• Data Siswa (${studentsData.length} records)</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs max-h-32 overflow-y-auto font-mono">
                                ${studentsData.length > 0 ? 
                                    studentsData.slice(0, 5).map(s => 
                                        `NISN: ${s.NISN || 'N/A'} | Nama: ${s.Nama || 'N/A'} | Kelas: ${s.Kelas || 'N/A'}`
                                    ).join('<br>') + (studentsData.length > 5 ? '<br>... dan ' + (studentsData.length - 5) + ' lainnya' : '')
                                    : '<span class="text-red-600">‚ùå Tidak ada data siswa yang dimuat</span>'
                                }
                            </div>
                        </div>

                        <!-- Data Guru -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üë®‚Äçüè´ Data Guru (${teachersData.length} records)</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs max-h-32 overflow-y-auto font-mono">
                                ${teachersData.length > 0 ? 
                                    teachersData.slice(0, 5).map(t => 
                                        `NIP: ${t.NIP || 'N/A'} | Nama: ${t.Nama || 'N/A'} | Mapel: ${t['Mata Pelajaran'] || 'N/A'} | Email: ${t.Email || 'N/A'}`
                                    ).join('<br>') + (teachersData.length > 5 ? '<br>... dan ' + (teachersData.length - 5) + ' lainnya' : '') +
                                    '<br><br><strong>üîç Struktur kolom guru:</strong><br>' + 
                                    (teachersData.length > 0 ? Object.keys(teachersData[0]).join(', ') : 'Tidak ada data')
                                    : '<span class="text-red-600">‚ùå Tidak ada data guru yang dimuat</span>'
                                }
                            </div>
                        </div>

                        <!-- Data Materi -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üìö Data Materi Pembelajaran (${materialsData.length} records)</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs max-h-32 overflow-y-auto font-mono">
                                ${materialsData.length > 0 ? 
                                    materialsData.slice(0, 3).map(m => 
                                        `ID: ${m.ID || 'N/A'} | Judul: ${m.Judul || 'N/A'} | Mapel: ${m['Mata Pelajaran'] || 'N/A'} | Kelas: ${m.Kelas || 'N/A'}`
                                    ).join('<br>') + (materialsData.length > 3 ? '<br>... dan ' + (materialsData.length - 3) + ' lainnya' : '')
                                    : '<span class="text-red-600">‚ùå Tidak ada data materi yang dimuat</span>'
                                }
                            </div>
                        </div>

                        <!-- Data LKPD -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üìù Data LKPD (${lkpdData.length} records)</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs max-h-32 overflow-y-auto font-mono">
                                ${lkpdData.length > 0 ? 
                                    lkpdData.slice(0, 3).map(l => {
                                        const id = l.ID || l.id || l.Id || 'N/A';
                                        const judul = l.Judul || l.judul || l.Title || 'N/A';
                                        const mapel = l['Mata Pelajaran'] || l['mata_pelajaran'] || l.MataPelajaran || l.Subject || 'N/A';
                                        const kelas = l.Kelas || l.kelas || l.Class || 'N/A';
                                        return `ID: ${id} | Judul: ${judul} | Mapel: ${mapel} | Kelas: ${kelas}`;
                                    }).join('<br>') + (lkpdData.length > 3 ? '<br>... dan ' + (lkpdData.length - 3) + ' lainnya' : '') +
                                    '<br><br><strong>üîç Struktur kolom LKPD:</strong><br>' + 
                                    (lkpdData.length > 0 ? Object.keys(lkpdData[0]).join(', ') : 'Tidak ada data')
                                    : '<span class="text-red-600">‚ùå Tidak ada data LKPD yang dimuat</span>'
                                }
                            </div>
                        </div>

                        <!-- URL Testing -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üîó URL Google Sheets yang Digunakan</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs">
                                <p class="mb-2"><strong>Sheet ID:</strong> ${SHEET_CONFIG.SHEET_ID}</p>
                                <p class="mb-2"><strong>Base URL:</strong></p>
                                <p class="font-mono text-blue-600 break-all">
                                    https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=[NAMA_SHEET]
                                </p>
                            </div>
                        </div>

                        <!-- Troubleshooting -->
                        <div class="border border-yellow-300 rounded-lg p-4 bg-yellow-50">
                            <h4 class="font-semibold text-yellow-800 mb-2">üõ†Ô∏è Panduan Troubleshooting</h4>
                            <div class="text-sm text-yellow-800 space-y-2">
                                <div><strong>Jika semua data kosong:</strong></div>
                                <ul class="list-disc list-inside ml-4 space-y-1">
                                    <li>Pastikan Google Sheets diatur sebagai "Anyone with link can view"</li>
                                    <li>Cek nama sheet harus persis: DataSiswa, DataGuru, MateriPelajaran, LKPD</li>
                                    <li>Pastikan baris pertama berisi header kolom</li>
                                    <li>Pastikan tidak ada baris kosong di awal data</li>
                                </ul>
                                
                                <div class="mt-3"><strong>Format kolom yang diperlukan:</strong></div>
                                <ul class="list-disc list-inside ml-4 space-y-1 text-xs">
                                    <li><strong>DataSiswa:</strong> NISN, Nama, Kelas</li>
                                    <li><strong>DataGuru:</strong> NIP, Nama, Mata Pelajaran, Email</li>
                                    <li><strong>MateriPelajaran:</strong> ID, Judul, Deskripsi, Mata Pelajaran, Kelas, Tipe, Link</li>
                                    <li><strong>LKPD:</strong> ID, Judul, Mata Pelajaran, Kelas, Link, Deskripsi</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Refresh Button -->
                        <div class="text-center">
                            <button onclick="this.closest('.fixed').remove(); loadAllData();" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                üîÑ Refresh Data Sekarang
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(debugModal);
        }

        function logout() {
            currentUser = null;
            showLoginScreen();
            showNotification('Anda telah logout');
        }

        // UI Functions
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard-screen').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            updateDashboard();
        }

        function updateDashboard() {
            if (!currentUser) return;

            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-info').textContent = 
                currentUser.type === 'student' ? `Kelas ${currentUser.class}` : `Guru ${currentUser.subject}`;

            if (currentUser.type === 'student') {
                showStudentDashboard();
            } else {
                showTeacherDashboard();
            }
        }

        function showStudentDashboard() {
            const studentClass = currentUser.class ? currentUser.class.toString().trim() : '';
            const classNumber = studentClass.charAt(0); // Get class number (7, 8, 9)
            console.log(`üë• Student dashboard - Full Class: "${studentClass}", Class Number: "${classNumber}"`);
            
            // Filter materials dengan berbagai kemungkinan field names dan format
            const availableMaterials = materialsData.filter(m => {
                const kelas = (m.Kelas || m.kelas || m.Class || m.class || m['Kelas'] || '').toString().trim();
                const match = kelas === studentClass || kelas === classNumber || kelas.includes(classNumber);
                console.log(`üìö Material class check: "${kelas}" vs "${studentClass}"/"${classNumber}" = ${match}`);
                return match;
            });
            
            // Filter LKPD dengan berbagai kemungkinan field names dan format - lebih fleksibel
            const availableLKPD = lkpdData.filter(l => {
                const kelas = (l.Kelas || l.kelas || l.Class || l.class || l['Kelas'] || '').toString().trim();
                const match = kelas === studentClass || kelas === classNumber || kelas.includes(classNumber) || 
                             studentClass.includes(kelas) || classNumber === kelas;
                console.log(`üìù LKPD class check: "${kelas}" vs "${studentClass}"/"${classNumber}" = ${match}`);
                return match;
            });

            console.log(`üìö Available materials for class ${studentClass}:`, availableMaterials.length);
            console.log(`üìù Available LKPD for class ${studentClass}:`, availableLKPD.length);
            console.log(`üìã All LKPD data:`, lkpdData.map(l => ({
                judul: l.Judul || l.judul,
                kelas: l.Kelas || l.kelas || l.Class,
                link: l.Link || l.link
            })));

            renderMaterials(availableMaterials);
            renderLKPD(availableLKPD);
            updateStudentProgress();
        }

        function showTeacherDashboard() {
            const teacherSubject = currentUser.subject || '';
            console.log(`üë®‚Äçüè´ Teacher dashboard - Subject: ${teacherSubject}`);
            
            // Filter materials dengan berbagai kemungkinan field names
            const subjectMaterials = materialsData.filter(m => {
                const mataPelajaran = m['Mata Pelajaran'] || m['mata_pelajaran'] || m.MataPelajaran || m.Subject || m.subject || '';
                return mataPelajaran === teacherSubject;
            });
            
            // Filter LKPD dengan berbagai kemungkinan field names
            const subjectLKPD = lkpdData.filter(l => {
                const mataPelajaran = l['Mata Pelajaran'] || l['mata_pelajaran'] || l.MataPelajaran || l.Subject || l.subject || '';
                return mataPelajaran === teacherSubject;
            });

            console.log(`üìö Available materials for subject ${teacherSubject}:`, subjectMaterials.length);
            console.log(`üìù Available LKPD for subject ${teacherSubject}:`, subjectLKPD.length);

            renderMaterials(subjectMaterials);
            renderLKPD(subjectLKPD);
            renderStudentProgress();
        }

        function renderMaterials(materials) {
            const container = document.getElementById('materials-container');
            container.innerHTML = '';

            if (materials.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada materi tersedia</p>';
                return;
            }

            materials.forEach(material => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover fade-in';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${material.Judul}</h3>
                            <p class="text-sm text-gray-600 mb-2">${material.Deskripsi}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${material['Mata Pelajaran']}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${material.Kelas}</span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">${material.Tipe}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            ${material.Tipe === 'video' ? 'üé•' : 'üìÑ'}
                        </div>
                    </div>
                    <button onclick="accessMaterial('${material.ID}', '${material.Judul}', '${material.Link}', '${material['Mata Pelajaran']}')" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        Akses Materi
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderLKPD(lkpdList) {
            const container = document.getElementById('lkpd-container');
            container.innerHTML = '';

            console.log(`üìù Rendering LKPD:`, lkpdList.length, 'items');
            console.log(`üìã Sample LKPD data:`, lkpdList.slice(0, 2));

            if (lkpdList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada LKPD tersedia</p>';
                return;
            }

            lkpdList.forEach((lkpd, index) => {
                // Sesuai dengan struktur kolom yang disebutkan: ID, Judul, Mata Pelajaran, Kelas, Link, Deskripsi
                const id = lkpd.ID || lkpd.id || lkpd.Id || lkpd['ID'] || `lkpd-${index}`;
                const judul = lkpd.Judul || lkpd.judul || lkpd.Title || lkpd.title || lkpd['Judul'] || 'LKPD Tanpa Judul';
                const mataPelajaran = lkpd['Mata Pelajaran'] || lkpd['mata_pelajaran'] || lkpd.MataPelajaran || lkpd.Subject || lkpd.subject || 'Umum';
                const kelas = lkpd.Kelas || lkpd.kelas || lkpd.Class || lkpd.class || lkpd['Kelas'] || '-';
                const link = lkpd.Link || lkpd.link || lkpd.URL || lkpd.url || lkpd['Link'] || '';
                const deskripsi = lkpd.Deskripsi || lkpd.deskripsi || lkpd.Description || lkpd.description || lkpd['Deskripsi'] || 'Tidak ada deskripsi';

                console.log(`üìù LKPD ${index + 1}:`, {
                    id, judul, mataPelajaran, kelas, link, deskripsi,
                    originalData: lkpd,
                    availableKeys: Object.keys(lkpd)
                });

                // Enhanced link validation dengan lebih banyak format
                let isValidLink = false;
                let normalizedLink = '';
                let linkStatus = '';
                
                if (link && link.trim() !== '' && link !== '#' && link.toLowerCase() !== 'null' && link.toLowerCase() !== 'undefined') {
                    const trimmedLink = link.trim();
                    
                    // Cek berbagai format link dengan validasi yang lebih ketat
                    if (trimmedLink.match(/^https?:\/\/.+/)) {
                        // Link dengan protokol lengkap
                        normalizedLink = trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Valid HTTP/HTTPS';
                    } else if (trimmedLink.match(/^www\..+\..+/)) {
                        // Link dengan www
                        normalizedLink = 'https://' + trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Valid WWW (ditambah https)';
                    } else if (trimmedLink.match(/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}/) && !trimmedLink.includes(' ')) {
                        // Domain tanpa protokol (format domain yang valid)
                        normalizedLink = 'https://' + trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Valid domain (ditambah https)';
                    } else if (trimmedLink.startsWith('//')) {
                        // Protocol-relative URL
                        normalizedLink = 'https:' + trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Protocol-relative (ditambah https)';
                    } else if (trimmedLink.match(/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/) && !trimmedLink.includes(' ')) {
                        // Kemungkinan domain sederhana
                        normalizedLink = 'https://' + trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Kemungkinan domain (ditambah https)';
                    } else {
                        linkStatus = 'Format tidak dikenali';
                    }
                } else {
                    linkStatus = 'Link kosong atau tidak valid';
                }

                console.log(`üîó Enhanced link validation for LKPD ${index + 1}:`, {
                    original: link,
                    normalized: normalizedLink,
                    isValid: isValidLink,
                    status: linkStatus
                });

                // Create unique button ID untuk menghindari konflik
                const buttonId = `lkpd-btn-${index}`;

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover fade-in';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${judul}</h3>
                            <p class="text-sm text-gray-600 mb-2">${deskripsi}</p>
                            <div class="flex items-center space-x-2 text-sm text-gray-500 flex-wrap gap-2">
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">${mataPelajaran}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${kelas}</span>
                                ${isValidLink ? 
                                    '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">‚úì Link Tersedia</span>' : 
                                    '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">‚úó No Link</span>'
                                }
                            </div>
                            ${link && link.trim() !== '' ? `
                                <div class="mt-2 p-2 bg-gray-50 rounded text-xs">
                                    <p class="text-gray-600"><strong>Link asli:</strong> ${link}</p>
                                    ${isValidLink ? `<p class="text-green-600"><strong>Link final:</strong> ${normalizedLink}</p>` : ''}
                                    <p class="text-blue-600"><strong>Status:</strong> ${linkStatus}</p>
                                </div>
                            ` : ''}
                        </div>
                        <div class="ml-4">üìù</div>
                    </div>
                    <button id="${buttonId}" 
                            data-lkpd-id="${id}"
                            data-lkpd-title="${judul}"
                            data-lkpd-link="${normalizedLink}"
                            data-lkpd-subject="${mataPelajaran}"
                            class="w-full py-2 px-4 rounded-lg transition-colors font-medium ${isValidLink ? 'bg-orange-600 text-white hover:bg-orange-700 active:bg-orange-800' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
                            ${!isValidLink ? 'disabled' : ''}>
                        ${isValidLink ? 'Kerjakan LKPD' : 'Link Tidak Tersedia'}
                    </button>
                    ${isValidLink ? `
                        <button onclick="testLKPDLink('${normalizedLink}', '${judul}')" 
                                class="w-full mt-2 py-1 px-4 rounded text-xs bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                            üîó Test Link
                        </button>
                    ` : ''}
                `;
                container.appendChild(card);

                // Add event listener dengan multiple fallback methods
                if (isValidLink) {
                    const button = document.getElementById(buttonId);
                    if (button) {
                        // Method 1: addEventListener
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log(`üñ±Ô∏è Button clicked for LKPD: ${judul}`);
                            accessLKPD(id, judul, normalizedLink, mataPelajaran);
                        });

                        // Method 2: onclick as backup
                        button.onclick = function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log(`üñ±Ô∏è Button onclick for LKPD: ${judul}`);
                            accessLKPD(id, judul, normalizedLink, mataPelajaran);
                        };

                        // Method 3: Touch events for mobile
                        button.addEventListener('touchend', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log(`üì± Button touch for LKPD: ${judul}`);
                            accessLKPD(id, judul, normalizedLink, mataPelajaran);
                        });

                        console.log(`‚úÖ Event listeners added for button: ${buttonId}`);
                    } else {
                        console.error(`‚ùå Button not found: ${buttonId}`);
                    }
                }
            });

            // Add global click handler as additional fallback
            container.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-lkpd-id]');
                if (button && !button.disabled) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const id = button.getAttribute('data-lkpd-id');
                    const title = button.getAttribute('data-lkpd-title');
                    const link = button.getAttribute('data-lkpd-link');
                    const subject = button.getAttribute('data-lkpd-subject');
                    
                    console.log(`üéØ Global click handler for LKPD: ${title}`);
                    accessLKPD(id, title, link, subject);
                }
            });
        }

        async function accessMaterial(materialId, title, link, subject) {
            if (currentUser && currentUser.type === 'student') {
                await saveProgress({
                    student_id: currentUser.id,
                    student_name: currentUser.name,
                    class_grade: currentUser.class,
                    subject: subject,
                    material_id: materialId,
                    material_title: title,
                    progress_type: 'material_access',
                    progress_value: 1,
                    session_duration: 0
                });
            }
            
            window.open(link, '_blank', 'noopener,noreferrer');
        }

        async function accessLKPD(lkpdId, title, link, subject) {
            console.log(`üöÄ accessLKPD called with:`, { lkpdId, title, link, subject });
            
            // Validasi link sebelum membuka
            if (!link || link === '#' || link.trim() === '') {
                showNotification('Link LKPD tidak tersedia atau tidak valid', 'error');
                console.error('‚ùå Invalid link:', link);
                return;
            }

            // Enhanced normalisasi link
            let normalizedLink = link.trim();
            
            // Jika link tidak dimulai dengan protokol, tambahkan https://
            if (!normalizedLink.match(/^https?:\/\//)) {
                if (normalizedLink.startsWith('www.')) {
                    normalizedLink = 'https://' + normalizedLink;
                } else if (normalizedLink.includes('.') && !normalizedLink.includes(' ')) {
                    normalizedLink = 'https://' + normalizedLink;
                }
            }

            console.log(`üîó Final normalized link: ${normalizedLink}`);

            // Simpan progress jika user adalah siswa
            if (currentUser && currentUser.type === 'student') {
                try {
                    await saveProgress({
                        student_id: currentUser.id,
                        student_name: currentUser.name,
                        class_grade: currentUser.class,
                        subject: subject,
                        material_id: lkpdId,
                        material_title: title,
                        progress_type: 'lkpd_access',
                        progress_value: 1,
                        session_duration: 0
                    });
                    console.log('‚úÖ Progress saved successfully');
                } catch (progressError) {
                    console.warn('‚ö†Ô∏è Failed to save progress:', progressError);
                    // Continue with opening link even if progress save fails
                }
            }
            
            // Buka link dengan multiple fallback methods
            try {
                console.log(`üåê Attempting to open: ${normalizedLink}`);
                
                // Method 1: window.open dengan parameter lengkap
                const newWindow = window.open(normalizedLink, '_blank', 'noopener,noreferrer,width=1200,height=800');
                
                if (newWindow) {
                    console.log('‚úÖ Link opened successfully with window.open');
                    showNotification(`Membuka LKPD: ${title}`);
                } else {
                    // Method 2: Fallback jika popup diblokir
                    console.warn('‚ö†Ô∏è Popup blocked, trying alternative method');
                    
                    // Buat link temporary dan klik
                    const tempLink = document.createElement('a');
                    tempLink.href = normalizedLink;
                    tempLink.target = '_blank';
                    tempLink.rel = 'noopener noreferrer';
                    tempLink.style.display = 'none';
                    document.body.appendChild(tempLink);
                    tempLink.click();
                    document.body.removeChild(tempLink);
                    
                    console.log('‚úÖ Link opened with temporary anchor method');
                    showNotification(`Membuka LKPD: ${title} (popup mungkin diblokir)`);
                }
                
            } catch (error) {
                console.error('‚ùå Error opening LKPD:', error);
                showNotification(`Gagal membuka LKPD: ${error.message}`, 'error');
                
                // Method 3: Last resort - show link to user
                showLinkFallback(normalizedLink, title);
            }
        }

        function testLKPDLink(link, title) {
            console.log(`üß™ Testing LKPD link: ${link}`);
            
            // Show loading state
            showNotification('Menguji koneksi link...', 'info');
            
            // Test dengan fetch (untuk melihat apakah link accessible)
            fetch(link, { 
                method: 'HEAD', 
                mode: 'no-cors',
                cache: 'no-cache'
            })
            .then(() => {
                console.log('‚úÖ Link test successful');
                showNotification(`Link ${title} dapat diakses`, 'success');
                
                // Langsung buka link setelah test berhasil
                setTimeout(() => {
                    window.open(link, '_blank', 'noopener,noreferrer');
                }, 1000);
            })
            .catch((error) => {
                console.warn('‚ö†Ô∏è Link test failed (might be CORS):', error);
                showNotification(`Test link gagal (mungkin CORS), mencoba buka langsung...`, 'warning');
                
                // Tetap coba buka meskipun test gagal (karena CORS)
                setTimeout(() => {
                    window.open(link, '_blank', 'noopener,noreferrer');
                }, 1000);
            });
        }

        function showLinkFallback(link, title) {
            // Buat modal dengan link yang bisa diklik manual
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full p-6">
                    <h3 class="text-lg font-bold mb-4">üîó Link LKPD</h3>
                    <p class="text-gray-600 mb-4">Silakan klik link di bawah untuk membuka LKPD:</p>
                    <div class="mb-4">
                        <p class="font-semibold text-gray-800 mb-2">${title}</p>
                        <a href="${link}" target="_blank" rel="noopener noreferrer" 
                           class="block w-full p-3 bg-blue-50 border border-blue-200 rounded text-blue-600 hover:bg-blue-100 transition-colors break-all">
                            ${link}
                        </a>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.open('${link}', '_blank'); this.closest('.fixed').remove();" 
                                class="flex-1 bg-orange-600 text-white py-2 px-4 rounded hover:bg-orange-700">
                            Buka Link
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto remove after 30 seconds
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }, 30000);
        }

        function updateStudentProgress() {
            const studentProgress = progressData.filter(p => p.student_id === currentUser.id);
            const container = document.getElementById('progress-container');
            
            if (studentProgress.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada aktivitas pembelajaran</p>';
                return;
            }

            const progressBySubject = {};
            studentProgress.forEach(p => {
                if (!progressBySubject[p.subject]) {
                    progressBySubject[p.subject] = { materials: 0, lkpd: 0 };
                }
                if (p.progress_type === 'material_access') {
                    progressBySubject[p.subject].materials++;
                } else if (p.progress_type === 'lkpd_access') {
                    progressBySubject[p.subject].lkpd++;
                }
            });

            container.innerHTML = Object.entries(progressBySubject).map(([subject, progress]) => `
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h4 class="font-semibold text-gray-800 mb-2">${subject}</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Materi diakses:</span>
                            <span class="font-semibold">${progress.materials}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>LKPD dikerjakan:</span>
                            <span class="font-semibold">${progress.lkpd}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderStudentProgress() {
            const container = document.getElementById('progress-container');
            
            if (progressData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada data aktivitas siswa</p>';
                return;
            }

            const progressByStudent = {};
            progressData.forEach(p => {
                if (!progressByStudent[p.student_name]) {
                    progressByStudent[p.student_name] = { 
                        class: p.class_grade, 
                        materials: 0, 
                        lkpd: 0,
                        subjects: new Set()
                    };
                }
                progressByStudent[p.student_name].subjects.add(p.subject);
                if (p.progress_type === 'material_access') {
                    progressByStudent[p.student_name].materials++;
                } else if (p.progress_type === 'lkpd_access') {
                    progressByStudent[p.student_name].lkpd++;
                }
            });

            container.innerHTML = Object.entries(progressByStudent).map(([name, data]) => `
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-800">${name}</h4>
                        <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">${data.class}</span>
                    </div>
                    <div class="space-y-1 text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span>Materi diakses:</span>
                            <span class="font-semibold">${data.materials}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>LKPD dikerjakan:</span>
                            <span class="font-semibold">${data.lkpd}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Mata pelajaran:</span>
                            <span class="font-semibold">${data.subjects.size}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateProgressDisplay() {
            if (currentUser) {
                if (currentUser.type === 'student') {
                    updateStudentProgress();
                } else {
                    renderStudentProgress();
                }
            }
        }

        // Element SDK Implementation
        const render = async (config) => {
            document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
            document.getElementById('school-vision').textContent = config.school_vision || defaultConfig.school_vision;
            document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
            document.getElementById('footer-message').textContent = config.footer_message || defaultConfig.footer_message;
            
            // Apply colors
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
            
            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        };

        const mapToCapabilities = (config) => ({
            recolorables: [
                {
                    get: () => config.primary_color || defaultConfig.primary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    }
                },
                {
                    get: () => config.secondary_color || defaultConfig.secondary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ secondary_color: value });
                        }
                    }
                },
                {
                    get: () => config.accent_color || defaultConfig.accent_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ accent_color: value });
                        }
                    }
                }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
        });

        const mapToEditPanelValues = (config) => new Map([
            ["school_name", config.school_name || defaultConfig.school_name],
            ["school_vision", config.school_vision || defaultConfig.school_vision],
            ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
            ["footer_message", config.footer_message || defaultConfig.footer_message]
        ]);

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error("Failed to initialize data SDK");
                }
            }
            
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    render,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }

            await loadAllData();
        });
    </script><!-- Login Screen -->
  <div id="login-screen" class="min-h-full"><!-- Header -->
   <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-8">
     <div class="text-center">
      <h1 id="school-name" class="text-4xl font-bold mb-2">SMP Negeri 1 Indonesia</h1>
      <p id="school-vision" class="text-xl text-blue-100 mb-4">Mewujudkan Generasi Cerdas, Berkarakter, dan Berdaya Saing Global</p>
      <p id="welcome-message" class="text-lg text-blue-200">Selamat datang di portal pembelajaran digital yang inovatif</p>
     </div>
    </div>
   </header><!-- Login Section -->
   <div class="container mx-auto px-4 py-12">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
     <div class="text-center mb-8">
      <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">üéì</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Portal Pembelajaran</h2>
      <p class="text-gray-600">Masuk untuk mengakses materi dan LKPD</p>
     </div>
     <form onsubmit="handleLogin(event)" class="space-y-6">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pengguna</label> <select name="userType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">Pilih jenis pengguna</option> <option value="student">Siswa</option> <option value="teacher">Guru</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">ID Pengguna</label> <input type="text" name="identifier" required placeholder="Masukkan NISN (siswa) atau NIP (guru)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div><button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
       <div class="loading-indicator hidden items-center justify-center">
        <div class="loading-spinner mr-2"></div> Memuat...
       </div><span class="login-text">Masuk</span> </button> <!-- Debug Button --> <button type="button" onclick="showDebugInfo()" class="w-full mt-2 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors text-sm"> üîç Lihat Data yang Dimuat </button>
     </form>
     <div class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h3 class="font-semibold text-gray-800 mb-2">Petunjuk Login:</h3>
      <div class="text-sm text-gray-600 space-y-2">
       <div>
        <p><strong>Siswa:</strong> Gunakan NISN (Nomor Induk Siswa Nasional)</p>
        <p class="text-xs text-gray-500">Contoh: 2024001, 2024002, 2024003</p>
       </div>
       <div>
        <p><strong>Guru:</strong> Gunakan NIP (Nomor Induk Pegawai)</p>
        <p class="text-xs text-gray-500">Contoh: 196801011990031001</p>
       </div>
       <div class="mt-3 p-2 bg-blue-50 rounded border-l-4 border-blue-400">
        <p class="text-xs text-blue-700"><strong>Catatan:</strong> Pastikan data Anda sudah terdaftar di Google Sheets dan dapat diakses publik.</p>
       </div>
      </div>
     </div><!-- Login Help (Hidden by default) -->
     <div id="login-help" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg hidden">
      <h4 class="font-semibold text-red-800 mb-2">‚ùå Gagal Login?</h4>
      <div class="text-sm text-red-700 space-y-2">
       <p><strong>Kemungkinan penyebab:</strong></p>
       <ul class="list-disc list-inside space-y-1 ml-2">
        <li>ID belum terdaftar di Google Sheets</li>
        <li>Google Sheets belum diatur sebagai "Anyone with link can view"</li>
        <li>Nama sheet tidak sesuai (harus: DataSiswa, DataGuru)</li>
        <li>Kolom di sheet tidak sesuai format</li>
       </ul>
       <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
        <p class="text-xs text-yellow-800"><strong>Solusi:</strong> Hubungi administrator untuk memastikan data Anda sudah terdaftar dengan benar.</p>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Dashboard Screen -->
  <div id="dashboard-screen" class="min-h-full hidden"><!-- Header -->
   <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
     <div class="flex items-center justify-between">
      <div>
       <h1 class="text-2xl font-bold">Dashboard Pembelajaran</h1>
       <p class="text-blue-100"><span id="user-name">Pengguna</span> ‚Ä¢ <span id="user-info">Info</span></p>
      </div><button onclick="logout()" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg transition-colors"> Logout </button>
     </div>
    </div>
   </header>
   <div class="container mx-auto px-4 py-8"><!-- Navigation Tabs -->
    <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-8"><button onclick="showTab('materials')" id="materials-tab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-blue-600 shadow-sm"> üìö Materi Pembelajaran </button> <button onclick="showTab('lkpd')" id="lkpd-tab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-500 hover:text-gray-700"> üìù LKPD </button> <button onclick="showTab('progress')" id="progress-tab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-500 hover:text-gray-700"> üìä Progress </button>
    </div><!-- Tab Contents -->
    <div id="materials-content" class="tab-content">
     <div class="mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-2">Materi Pembelajaran</h2>
      <p class="text-gray-600">Akses video pembelajaran dan dokumen materi</p>
     </div>
     <div id="materials-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-12">
       <div class="loading-spinner mr-2"></div><span>Memuat materi...</span>
      </div>
     </div>
    </div>
    <div id="lkpd-content" class="tab-content hidden">
     <div class="mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-2">Lembar Kerja Peserta Didik</h2>
      <p class="text-gray-600">Kerjakan LKPD untuk memperdalam pemahaman</p>
     </div>
     <div id="lkpd-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-12">
       <div class="loading-spinner mr-2"></div><span>Memuat LKPD...</span>
      </div>
     </div>
    </div>
    <div id="progress-content" class="tab-content hidden">
     <div class="mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-2">Progress Pembelajaran</h2>
      <p class="text-gray-600">Pantau aktivitas dan kemajuan pembelajaran</p>
     </div>
     <div id="progress-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-12">
       <div class="loading-spinner mr-2"></div><span>Memuat progress...</span>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Footer -->
  <footer class="bg-gray-800 text-white py-8 mt-12">
   <div class="container mx-auto px-4 text-center">
    <p id="footer-message" class="text-lg font-semibold mb-2">Merdeka Belajar - Indonesia Maju 2045</p>
    <p class="text-gray-400">¬© 2024 Sistem Pembelajaran Interaktif SMP</p>
   </div>
  </footer>
  <script>
        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('[id$="-tab"]').forEach(tab => {
                tab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                tab.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(`${tabName}-tab`);
            activeTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
            activeTab.classList.remove('text-gray-500', 'hover:text-gray-700');
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f0157143fc3d86',t:'MTc2MDUzOTM1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
