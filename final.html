<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Pembelajaran Digital SMP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success { background-color: #10b981; }
        .notification.error { background-color: #ef4444; }
        .notification.info { background-color: #3b82f6; }
        .notification.warning { background-color: #f59e0b; }
    </style>
 </head>
 <body class="h-full bg-gray-50">
  <script>
        // Konfigurasi
        const defaultConfig = {
            school_name: "SMPN 10 BANAWA SELATAN",
            school_vision: "Mewujudkan Generasi Cerdas, Berkarakter, dan Berdaya Saing Global",
            welcome_message: "Selamat datang di portal pembelajaran digital yang inovatif",
            footer_message: "MKKS DONGGALA 1 - Kombel Tonda Talusi - SOU BATIK - ",
            primary_color: "#3b82f6",
            secondary_color: "#10b981",
            accent_color: "#f59e0b"
        };

        // Google Sheets Configuration
        const SHEET_CONFIG = {
            SHEET_ID: '1sbAafIEvxDjBnsrPLervTOHFi1OQWrYktb01ihXzHos',
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbynoa1pPEalKmlkOIc9zsyKhtJIYKSjeShpEV1b3tFUdAE2Rx5hRRpIxgDlTrijL-xd/exec', // Ganti dengan URL Web App Anda
            STUDENTS_SHEET: 'DataSiswa',
            TEACHERS_SHEET: 'DataGuru',
            MATERIALS_SHEET: 'MateriPelajaran',
            LKPD_SHEET: 'LKPD',
            PROGRESS_SHEET: 'ProgressSiswa',
            REKAP_PROGRES_SHEET: 'RekapProgres',
            REKAP_MATERI_SHEET: 'RekapMateri'
        };

        // Global State
        let currentUser = null;
        let studentsData = [];
        let teachersData = [];
        let materialsData = [];
        let lkpdData = [];
        let progressData = [];
        let rekapProgresData = [];
        let rekapMateriData = [];
        let isLoading = false;
        let currentRecordCount = 0;

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                progressData = data;
                currentRecordCount = data.length;
                updateProgressDisplay();
            }
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function showLoading(show = true) {
            isLoading = show;
            const loadingElements = document.querySelectorAll('.loading-indicator');
            loadingElements.forEach(el => {
                el.style.display = show ? 'flex' : 'none';
            });
        }

        function formatDateIndonesia(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Google Sheets Integration
        async function callGoogleScript(action, data = {}) {
            try {
                const payload = {
                    action: action,
                    ...data
                };

                console.log(`üì° Calling Google Script: ${action}`, payload);

                const response = await fetch(SHEET_CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log(`‚úÖ Google Script response:`, result);

                if (!result.success) {
                    throw new Error(result.error || 'Unknown error from Google Script');
                }

                return result.data;

            } catch (error) {
                console.error(`‚ùå Google Script error (${action}):`, error);
                throw error;
            }
        }

        async function fetchGoogleSheetData(sheetName) {
            try {
                console.log(`üîÑ Fetching data from sheet: ${sheetName}`);
                
                const data = await callGoogleScript('getRecords', {
                    sheetName: sheetName
                });

                console.log(`‚úÖ Loaded ${sheetName}: ${data.records?.length || 0} records`);
                return data.records || [];

            } catch (error) {
                console.error(`üí• Error fetching ${sheetName}:`, error);
                showNotification(`Gagal memuat ${sheetName}: ${error.message}`, 'error');
                return [];
            }
        }

        async function saveToGoogleSheets(sheetName, recordData) {
            try {
                console.log(`üìù Saving to ${sheetName}:`, recordData);
                
                const result = await callGoogleScript('addRecord', {
                    sheetName: sheetName,
                    data: recordData
                });

                console.log(`‚úÖ Saved to ${sheetName}:`, result);
                showNotification(`Data berhasil disimpan ke ${sheetName}`, 'success');
                
                return result;

            } catch (error) {
                console.error(`‚ùå Error saving to ${sheetName}:`, error);
                showNotification(`Gagal menyimpan ke ${sheetName}: ${error.message}`, 'error');
                throw error;
            }
        }

        async function createRekapMateriSheet() {
            try {
                console.log('üîß Creating RekapMateri sheet if not exists...');
                
                const result = await callGoogleScript('createSheet', {
                    sheetName: SHEET_CONFIG.REKAP_MATERI_SHEET,
                    headers: ['Tanggal', 'NISN', 'Nama', 'Kelas', 'Jenis Kelamin', 'Email', 'Materi', 'Mata Pelajaran']
                });

                console.log('‚úÖ RekapMateri sheet ready:', result);
                return true;

            } catch (error) {
                console.error('‚ùå Error creating RekapMateri sheet:', error);
                return false;
            }
        }

        async function loadAllData() {
            showLoading(true);
            try {
                // Pastikan sheet RekapMateri ada
                await createRekapMateriSheet();
                
                // Load semua data secara paralel
                const [students, teachers, materials, lkpd, rekapProgres, rekapMateri] = await Promise.all([
                    fetchGoogleSheetData(SHEET_CONFIG.STUDENTS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.TEACHERS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.MATERIALS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.LKPD_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.REKAP_PROGRES_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.REKAP_MATERI_SHEET)
                ]);
                
                studentsData = students;
                teachersData = teachers;
                materialsData = materials;
                lkpdData = lkpd;
                rekapProgresData = rekapProgres;
                rekapMateriData = rekapMateri;
                
                console.log(`üìä Data loaded:`, {
                    students: studentsData.length,
                    teachers: teachersData.length,
                    materials: materialsData.length,
                    lkpd: lkpdData.length,
                    rekapProgres: rekapProgresData.length,
                    rekapMateri: rekapMateriData.length
                });
                
                showNotification('Data berhasil dimuat dari Google Sheets');
                startRealTimeSync();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Gagal memuat data dari Google Sheets', 'error');
            } finally {
                showLoading(false);
            }
        }

        let realTimeSyncInterval = null;

        function startRealTimeSync() {
            if (realTimeSyncInterval) {
                clearInterval(realTimeSyncInterval);
            }
            
            console.log('üîÑ Starting real-time sync...');
            
            realTimeSyncInterval = setInterval(async () => {
                try {
                    const newRekapMateriData = await fetchGoogleSheetData(SHEET_CONFIG.REKAP_MATERI_SHEET);
                    
                    if (newRekapMateriData.length !== rekapMateriData.length) {
                        const oldCount = rekapMateriData.length;
                        rekapMateriData = newRekapMateriData;
                        
                        if (currentUser && currentUser.type === 'teacher') {
                            updateTeacherDashboard();
                            
                            const newRecords = newRekapMateriData.length - oldCount;
                            if (newRecords > 0) {
                                showNotification(`${newRecords} aktivitas materi baru terdeteksi!`, 'info');
                            }
                        }
                    }
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Real-time sync error:', error);
                }
            }, 30000); // 30 detik
        }

        function stopRealTimeSync() {
            if (realTimeSyncInterval) {
                clearInterval(realTimeSyncInterval);
                realTimeSyncInterval = null;
            }
        }

        async function saveProgress(progressData) {
            if (currentRecordCount >= 999) {
                showNotification('Batas maksimum 999 record tercapai', 'error');
                return;
            }

            showLoading(true);
            try {
                const result = await window.dataSdk.create({
                    student_id: progressData.student_id,
                    student_name: progressData.student_name,
                    class_grade: progressData.class_grade,
                    subject: progressData.subject,
                    material_id: progressData.material_id,
                    material_title: progressData.material_title,
                    progress_type: progressData.progress_type,
                    progress_value: progressData.progress_value,
                    timestamp: new Date().toISOString()
                });

                if (result.isOk) {
                    showNotification('Progress berhasil disimpan');
                    
                    if (progressData.progress_type === 'lkpd_access') {
                        await saveToRekapProgres(progressData);
                    } else if (progressData.progress_type === 'material_access') {
                        await saveToRekapMateri(progressData);
                    }
                } else {
                    showNotification('Gagal menyimpan progress', 'error');
                }
            } catch (error) {
                showNotification('Error menyimpan progress', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveToRekapProgres(progressData) {
            try {
                const today = formatDateIndonesia(new Date());
                
                const newRecord = {
                    'Tanggal': today,
                    'NISN': progressData.student_id,
                    'Nama': progressData.student_name,
                    'Kelas': progressData.class_grade,
                    'LKPD': progressData.material_title
                };
                
                await saveToGoogleSheets(SHEET_CONFIG.REKAP_PROGRES_SHEET, newRecord);
                rekapProgresData.push(newRecord);
                
            } catch (error) {
                console.warn('Error saving to RekapProgres:', error);
            }
        }

        async function saveToRekapMateri(progressData) {
            try {
                const today = formatDateIndonesia(new Date());
                
                const studentData = studentsData.find(s => s.NISN === progressData.student_id);
                
                const newRecord = {
                    'Tanggal': today,
                    'NISN': progressData.student_id,
                    'Nama': progressData.student_name,
                    'Kelas': progressData.class_grade,
                    'Jenis Kelamin': studentData?.['Jenis Kelamin'] || '',
                    'Email': studentData?.Email || '',
                    'Materi': progressData.material_title,
                    'Mata Pelajaran': progressData.subject
                };
                
                await saveToGoogleSheets(SHEET_CONFIG.REKAP_MATERI_SHEET, newRecord);
                rekapMateriData.push(newRecord);
                
            } catch (error) {
                console.warn('Error saving to RekapMateri:', error);
            }
        }

        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userType = formData.get('userType');
            const identifier = formData.get('identifier');

            if (!userType || !identifier) {
                showNotification('Lengkapi semua field!', 'error');
                return;
            }

            showLoading(true);

            try {
                let user = null;
                
                if (userType === 'student') {
                    user = studentsData.find(s => s.NISN === identifier);
                    if (user) {
                        user.type = 'student';
                        user.id = user.NISN;
                        user.name = user.Nama;
                        user.class = user.Kelas;
                    }
                } else if (userType === 'teacher') {
                    user = teachersData.find(t => t.NIP === identifier);
                    if (user) {
                        user.type = 'teacher';
                        user.id = user.NIP;
                        user.name = user.Nama;
                        user.subject = user['Mata Pelajaran'];
                    }
                }

                if (user) {
                    currentUser = user;
                    showDashboard();
                    showNotification(`Selamat datang, ${user.name}!`);
                } else {
                    showNotification(`${userType === 'student' ? 'NISN' : 'NIP'} tidak ditemukan!`, 'error');
                }
            } catch (error) {
                showNotification('Terjadi kesalahan saat login', 'error');
            } finally {
                showLoading(false);
            }
        }

        function logout() {
            currentUser = null;
            stopRealTimeSync();
            showLoginScreen();
            showNotification('Anda telah logout');
        }

        // UI Functions
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard-screen').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            updateDashboard();
        }

        function updateDashboard() {
            if (!currentUser) return;

            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-info').textContent = 
                currentUser.type === 'student' ? `Kelas ${currentUser.class}` : `Guru ${currentUser.subject}`;

            if (currentUser.type === 'student') {
                showStudentDashboard();
            } else {
                showTeacherDashboard();
            }
        }

        function showStudentDashboard() {
            const studentClass = currentUser.class;
            
            const availableMaterials = materialsData.filter(m => 
                m.Kelas === studentClass || m.Kelas.includes(studentClass.charAt(0))
            );
            
            const availableLKPD = lkpdData.filter(l => 
                l.Kelas === studentClass || l.Kelas.includes(studentClass.charAt(0))
            );

            renderMaterials(availableMaterials);
            renderLKPD(availableLKPD);
            updateStudentProgress();
        }

        function showTeacherDashboard() {
            const teacherSubject = currentUser.subject;
            
            const subjectMaterials = materialsData.filter(m => 
                m['Mata Pelajaran'] === teacherSubject
            );
            
            const subjectLKPD = lkpdData.filter(l => 
                l['Mata Pelajaran'] === teacherSubject
            );

            renderTeacherMaterials(subjectMaterials);
            renderTeacherLKPD(subjectLKPD);
            renderTeacherProgress();
        }

        function updateTeacherDashboard() {
            if (currentUser && currentUser.type === 'teacher') {
                showTeacherDashboard();
            }
        }

        function renderMaterials(materials) {
            const container = document.getElementById('materials-container');
            container.innerHTML = '';

            if (materials.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada materi tersedia</p>';
                return;
            }

            materials.forEach(material => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${material.Judul}</h3>
                            <p class="text-sm text-gray-600 mb-2">${material.Deskripsi}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${material['Mata Pelajaran']}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${material.Kelas}</span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">${material.Tipe}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            ${material.Tipe === 'video' ? 'üé•' : 'üìÑ'}
                        </div>
                    </div>
                    <button onclick="accessMaterial('${material.ID}', '${material.Judul}', '${material.Link}', '${material['Mata Pelajaran']}')" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        Akses Materi
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderTeacherMaterials(materials) {
            const container = document.getElementById('materials-container');
            container.innerHTML = '';

            if (materials.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada materi tersedia</p>';
                return;
            }

            materials.forEach(material => {
                const studentsWhoAccessed = rekapMateriData.filter(record => 
                    record.Materi === material.Judul
                );

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${material.Judul}</h3>
                            <p class="text-sm text-gray-600 mb-2">${material.Deskripsi}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${material['Mata Pelajaran']}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${material.Kelas}</span>
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">${studentsWhoAccessed.length} siswa mengakses</span>
                            </div>
                        </div>
                        <div class="ml-4">üìÑ</div>
                    </div>
                    <button onclick="showMaterialDetail('${material.ID}', '${material.Judul}')" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        üìä Detail Akses (${studentsWhoAccessed.length} siswa)
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderLKPD(lkpdList) {
            const container = document.getElementById('lkpd-container');
            container.innerHTML = '';

            if (lkpdList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada LKPD tersedia</p>';
                return;
            }

            lkpdList.forEach(lkpd => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${lkpd.Judul}</h3>
                            <p class="text-sm text-gray-600 mb-2">${lkpd.Deskripsi || 'Tidak ada deskripsi'}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">${lkpd['Mata Pelajaran']}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${lkpd.Kelas}</span>
                            </div>
                        </div>
                        <div class="ml-4">üìù</div>
                    </div>
                    <button onclick="accessLKPD('${lkpd.ID}', '${lkpd.Judul}', '${lkpd.Link}', '${lkpd['Mata Pelajaran']}')" 
                            class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                        üöÄ Kerjakan LKPD
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderTeacherLKPD(lkpdList) {
            const container = document.getElementById('lkpd-container');
            container.innerHTML = '';

            if (lkpdList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada LKPD tersedia</p>';
                return;
            }

            lkpdList.forEach(lkpd => {
                const studentsWhoWorked = rekapProgresData.filter(record => 
                    record.LKPD === lkpd.Judul
                );

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${lkpd.Judul}</h3>
                            <p class="text-sm text-gray-600 mb-2">${lkpd.Deskripsi || 'Tidak ada deskripsi'}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">${lkpd['Mata Pelajaran']}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${lkpd.Kelas}</span>
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${studentsWhoWorked.length} siswa mengerjakan</span>
                            </div>
                        </div>
                        <div class="ml-4">üìù</div>
                    </div>
                    <button onclick="showLKPDDetail('${lkpd.ID}', '${lkpd.Judul}')" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        üìä Detail Pengerjaan (${studentsWhoWorked.length} siswa)
                    </button>
                `;
                container.appendChild(card);
            });
        }

        async function accessMaterial(materialId, title, link, subject) {
            if (currentUser && currentUser.type === 'student') {
                const progressData = {
                    student_id: currentUser.id,
                    student_name: currentUser.name,
                    class_grade: currentUser.class,
                    subject: subject,
                    material_id: materialId,
                    material_title: title,
                    progress_type: 'material_access',
                    progress_value: 1
                };

                await saveProgress(progressData);
            }
            
            window.open(link, '_blank', 'noopener,noreferrer');
        }

        async function accessLKPD(lkpdId, title, link, subject) {
            if (currentUser && currentUser.type === 'student') {
                const progressData = {
                    student_id: currentUser.id,
                    student_name: currentUser.name,
                    class_grade: currentUser.class,
                    subject: subject,
                    material_id: lkpdId,
                    material_title: title,
                    progress_type: 'lkpd_access',
                    progress_value: 1
                };

                await saveProgress(progressData);
            }
            
            window.open(link, '_blank', 'noopener,noreferrer');
        }

        function showMaterialDetail(materialId, materialTitle) {
            const studentsWhoAccessed = rekapMateriData.filter(record => 
                record.Materi === materialTitle
            );

            if (studentsWhoAccessed.length === 0) {
                showNotification('Belum ada siswa yang mengakses materi ini', 'info');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üìö Detail Akses Materi: ${materialTitle}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left">No</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">NISN</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kelas</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Tanggal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentsWhoAccessed.map((student, index) => `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="border border-gray-300 px-4 py-2">${index + 1}</td>
                                        <td class="border border-gray-300 px-4 py-2">${student.NISN}</td>
                                        <td class="border border-gray-300 px-4 py-2">${student.Nama}</td>
                                        <td class="border border-gray-300 px-4 py-2">${student.Kelas}</td>
                                        <td class="border border-gray-300 px-4 py-2">${student.Tanggal}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showLKPDDetail(lkpdId, lkpdTitle) {
            const studentsWhoWorked = rekapProgresData.filter(record => 
                record.LKPD === lkpdTitle
            );

            if (studentsWhoWorked.length === 0) {
                showNotification('Belum ada siswa yang mengerjakan LKPD ini', 'info');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üìù Detail Pengerjaan LKPD: ${lkpdTitle}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="border border-gray-300 px-4 py-2 text-left">No</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">NISN</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Nama</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Kelas</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left">Tanggal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentsWhoWorked.map((student, index) => `
                                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                        <td class="border border-gray-300 px-4 py-2">${index + 1}</td>
                                        <td class="border border-gray-300 px-4 py-2">${student.NISN}</td>
                                        <td class="border border-gray-300 px-4 py-2">${student.Nama}</td>
                                        <td class="border border-gray-300 px-4 py-2">${student.Kelas}</td>
                                        <td class="border border-gray-300 px-4 py-2">${student.Tanggal}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateStudentProgress() {
            const container = document.getElementById('progress-container');
            const studentProgress = progressData.filter(p => p.student_id === currentUser.id);
            
            if (studentProgress.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada aktivitas pembelajaran</p>';
                return;
            }

            const progressBySubject = {};
            studentProgress.forEach(p => {
                if (!progressBySubject[p.subject]) {
                    progressBySubject[p.subject] = { materials: 0, lkpd: 0 };
                }
                if (p.progress_type === 'material_access') {
                    progressBySubject[p.subject].materials++;
                } else if (p.progress_type === 'lkpd_access') {
                    progressBySubject[p.subject].lkpd++;
                }
            });

            container.innerHTML = Object.entries(progressBySubject).map(([subject, progress]) => `
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h4 class="font-semibold text-gray-800 mb-2">${subject}</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Materi diakses:</span>
                            <span class="font-semibold">${progress.materials}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>LKPD dikerjakan:</span>
                            <span class="font-semibold">${progress.lkpd}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTeacherProgress() {
            const container = document.getElementById('progress-container');
            
            const teacherSubject = currentUser.subject;
            const subjectLKPDTitles = lkpdData
                .filter(l => l['Mata Pelajaran'] === teacherSubject)
                .map(l => l.Judul);

            const relevantProgress = rekapProgresData.filter(record => 
                subjectLKPDTitles.includes(record.LKPD)
            );

            if (relevantProgress.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="text-6xl mb-4">üìä</div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Belum Ada Aktivitas</h3>
                            <p class="text-gray-600">Belum ada siswa yang mengerjakan LKPD untuk mata pelajaran ${teacherSubject}</p>
                        </div>
                    </div>
                `;
                return;
            }

            const totalStudents = new Set(relevantProgress.map(p => p.NISN)).size;
            const totalLKPD = new Set(relevantProgress.map(p => p.LKPD)).size;

            container.innerHTML = `
                <div class="col-span-full mb-6">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üìä Overview Progress ${teacherSubject}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold">${totalStudents}</div>
                                <div class="text-sm text-blue-100">Siswa Aktif</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${totalLKPD}</div>
                                <div class="text-sm text-blue-100">LKPD Dikerjakan</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${relevantProgress.length}</div>
                                <div class="text-sm text-blue-100">Total Aktivitas</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateProgressDisplay() {
            if (currentUser) {
                if (currentUser.type === 'student') {
                    updateStudentProgress();
                } else {
                    renderTeacherProgress();
                }
            }
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
        }

        // Element SDK Implementation
        const render = async (config) => {
            document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
            document.getElementById('school-vision').textContent = config.school_vision || defaultConfig.school_vision;
            document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
            document.getElementById('footer-message').textContent = config.footer_message || defaultConfig.footer_message;
        };

        const mapToCapabilities = (config) => ({
            recolorables: [
                {
                    get: () => config.primary_color || defaultConfig.primary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    }
                }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
        });

        const mapToEditPanelValues = (config) => new Map([
            ["school_name", config.school_name || defaultConfig.school_name],
            ["school_vision", config.school_vision || defaultConfig.school_vision],
            ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
            ["footer_message", config.footer_message || defaultConfig.footer_message]
        ]);

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error("Failed to initialize data SDK");
                }
            }
            
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    render,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }

            await loadAllData();
        });
    </script><!-- Login Screen -->
  <div id="login-screen" class="min-h-full">
   <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-8">
     <div class="text-center">
      <h1 id="school-name" class="text-4xl font-bold mb-2">SMPN 10 BANAWA SELATAN</h1>
      <p id="school-vision" class="text-xl text-blue-100 mb-4">Mewujudkan Generasi Cerdas, Berkarakter, dan Berdaya Saing Global</p>
      <p id="welcome-message" class="text-lg text-blue-200">Selamat datang di portal pembelajaran digital yang inovatif</p>
     </div>
    </div>
   </header>
   <div class="container mx-auto px-4 py-12">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
     <div class="text-center mb-8">
      <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">üéì</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Portal Pembelajaran</h2>
      <p class="text-gray-600">Masuk untuk mengakses materi dan LKPD</p>
     </div>
     <form onsubmit="handleLogin(event)" class="space-y-6">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pengguna</label> <select name="userType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">Pilih jenis pengguna</option> <option value="student">Siswa</option> <option value="teacher">Guru</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">ID Pengguna</label> <input type="text" name="identifier" required placeholder="Masukkan NISN (siswa) atau NIP (guru)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div><button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
       <div class="loading-indicator hidden items-center justify-center">
        <div class="loading-spinner mr-2"></div> Memproses...
       </div><span class="login-text">üöÄ Masuk Portal</span> </button>
     </form>
    </div>
   </div>
   <footer class="bg-gray-800 text-white py-8 mt-12">
    <div class="container mx-auto px-4 text-center">
     <p id="footer-message" class="text-lg mb-4">KOMBEL TONDA TALUSI - SOUBATIK - MKKS DONGGALA 1</p>
     <p class="text-gray-400 text-sm">¬© 2025 Sistem Pembelajaran Digital SMPN 10 BANAWA SELATAN</p>
    </div>
   </footer>
  </div><!-- Dashboard Screen -->
  <div id="dashboard-screen" class="hidden min-h-full">
   <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
     <div class="flex justify-between items-center">
      <div>
       <h1 class="text-2xl font-bold">Portal Pembelajaran</h1>
       <p class="text-blue-200">Dashboard Pengguna</p>
      </div>
      <div class="text-right">
       <div class="flex items-center space-x-4">
        <div>
         <p id="user-name" class="font-semibold text-lg">Nama Pengguna</p>
         <p id="user-info" class="text-sm text-blue-200">Info Pengguna</p>
        </div><button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors"> üö™ Logout </button>
       </div>
      </div>
     </div>
    </div>
   </header>
   <div class="container mx-auto px-4 py-8">
    <div class="mb-8">
     <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8"><button onclick="showTab('materials')" id="materials-tab" class="tab-button py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600"> üìö Materi Pembelajaran </button> <button onclick="showTab('lkpd')" id="lkpd-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700"> üìù LKPD </button> <button onclick="showTab('progress')" id="progress-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700"> üìä Progress </button>
      </nav>
     </div>
    </div>
    <div id="materials-content" class="tab-content">
     <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">üìö Materi Pembelajaran</h2>
      <p class="text-gray-600">Akses materi pembelajaran sesuai dengan kelas dan mata pelajaran</p>
     </div>
     <div id="materials-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-8">
       <div class="loading-spinner mr-2"></div> Memuat materi...
      </div>
     </div>
    </div>
    <div id="lkpd-content" class="tab-content hidden">
     <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">üìù Lembar Kerja Peserta Didik</h2>
      <p class="text-gray-600">Kerjakan LKPD sesuai dengan mata pelajaran dan kelas</p>
     </div>
     <div id="lkpd-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-8">
       <div class="loading-spinner mr-2"></div> Memuat LKPD...
      </div>
     </div>
    </div>
    <div id="progress-content" class="tab-content hidden">
     <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">üìä Progress Pembelajaran</h2>
      <p class="text-gray-600">Pantau kemajuan pembelajaran dan aktivitas</p>
     </div>
     <div id="progress-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-8">
       <div class="loading-spinner mr-2"></div> Memuat progress...
      </div>
     </div>
    </div>
   </div>
   <footer class="bg-gray-800 text-white py-6 mt-12">
    <div class="container mx-auto px-4 text-center">
     <p class="text-lg mb-2">SOU BATIK - MKKS DONGGALA 1</p>
     <p class="text-gray-400 text-sm">¬© 2025 SMPN 10 BANAWA SELATAN</p>
    </div>
   </footer>
  </div>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f142ee276ffd2a',t:'MTc2MDU1MTcwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
