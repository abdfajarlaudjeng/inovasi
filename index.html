<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Pembelajaran Interaktif SMP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .progress-bar {
            transition: width 0.5s ease;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: #10b981;
        }
        .notification.error {
            background-color: #ef4444;
        }
        .notification.info {
            background-color: #3b82f6;
        }
        .notification.warning {
            background-color: #f59e0b;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
 </head>
 <body class="h-full bg-gray-50">
  <script>
        // Configuration
        const defaultConfig = {
            school_name: "SMP Negeri 1 Indonesia",
            school_vision: "Mewujudkan Generasi Cerdas, Berkarakter, dan Berdaya Saing Global",
            welcome_message: "Selamat datang di portal pembelajaran digital yang inovatif",
            footer_message: "Merdeka Belajar - Indonesia Maju 2045",
            primary_color: "#3b82f6",
            secondary_color: "#10b981",
            accent_color: "#f59e0b",
            text_color: "#1f2937",
            background_color: "#f9fafb"
        };

        // Google Sheets Configuration
        const SHEET_CONFIG = {
            SHEET_ID: '12damNTphrDElg1qsmAWVKoTrfXhDXKa8l660vhTNR8I',
            STUDENTS_SHEET: 'DataSiswa',
            TEACHERS_SHEET: 'DataGuru', 
            MATERIALS_SHEET: 'MateriPelajaran',
            LKPD_SHEET: 'LKPD',
            LKPD_GID: '1727674162',
            PROGRESS_SHEET: 'ProgressSiswa',
            REKAP_PROGRES_SHEET: 'RekapProgres',
            REKAP_PROGRES_GID: '955303067'
        };

        // Sheet column mappings
        const SHEET_COLUMNS = {
            DataSiswa: ['NISN', 'Nama', 'Kelas'],
            DataGuru: ['NIP', 'Nama', 'Mata Pelajaran', 'Email'],
            MateriPelajaran: ['ID', 'Judul', 'Deskripsi', 'Mata Pelajaran', 'Kelas', 'Tipe', 'Link'],
            LKPD: ['ID', 'Judul', 'Mata Pelajaran', 'Kelas', 'Link', 'Deskripsi'],
            ProgressSiswa: ['NISN', 'Nama', 'Kelas', 'Mata Pelajaran', 'Materi/LKPD', 'Jenis', 'Waktu'],
            RekapProgres: ['Tanggal', 'NISN', 'Nama', 'Kelas', 'LKPD']
        };

        // Global State
        let currentUser = null;
        let studentsData = [];
        let teachersData = [];
        let materialsData = [];
        let lkpdData = [];
        let progressData = [];
        let rekapProgresData = [];
        let isLoading = false;
        let currentRecordCount = 0;

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                progressData = data;
                currentRecordCount = data.length;
                updateProgressDisplay();
            }
        };

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function showLoading(show = true) {
            isLoading = show;
            const loadingElements = document.querySelectorAll('.loading-indicator');
            loadingElements.forEach(el => {
                el.style.display = show ? 'flex' : 'none';
            });
        }

        function formatDateIndonesia(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatTimeIndonesia(date) {
            const d = new Date(date);
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        async function fetchGoogleSheetData(sheetName) {
            try {
                console.log(`üîÑ Memulai fetch untuk sheet: ${sheetName}`);
                
                // Untuk sheet LKPD, gunakan GID spesifik
                if (sheetName === 'LKPD' && SHEET_CONFIG.LKPD_GID) {
                    return await fetchLKPDWithGID();
                }
                
                // Untuk sheet RekapProgres, gunakan GID spesifik
                if (sheetName === 'RekapProgres' && SHEET_CONFIG.REKAP_PROGRES_GID) {
                    return await fetchRekapProgresWithGID();
                }
                
                // Coba beberapa format URL yang berbeda dengan encoding yang tepat
                const encodedSheetName = encodeURIComponent(sheetName);
                const urls = [
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodedSheetName}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${encodedSheetName}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${sheetName}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=0&range=${sheetName}!A:Z`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&range=${sheetName}!A1:Z1000`
                ];

                let lastError = null;
                let attemptCount = 0;
                
                for (const url of urls) {
                    attemptCount++;
                    try {
                        console.log(`üì° Percobaan ${attemptCount}: ${url}`);
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json, text/plain, */*',
                                'Cache-Control': 'no-cache'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const text = await response.text();
                        console.log(`üìÑ Response length untuk ${sheetName}:`, text.length);
                        
                        if (text.length < 50) {
                            throw new Error('Response terlalu pendek, kemungkinan sheet tidak ditemukan');
                        }
                        
                        // Handle different response formats dengan lebih robust
                        let jsonText = text;
                        
                        if (text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) {
                            jsonText = text.substring(47, text.length - 2);
                        } else if (text.includes('google.visualization.Query.setResponse(')) {
                            const start = text.indexOf('google.visualization.Query.setResponse(') + 39;
                            const end = text.lastIndexOf(');');
                            if (end > start) {
                                jsonText = text.substring(start, end);
                            }
                        } else if (text.trim().startsWith('{')) {
                            jsonText = text;
                        }
                        
                        const json = JSON.parse(jsonText);
                        console.log(`üîç Parsed JSON structure untuk ${sheetName}:`, {
                            hasTable: !!json.table,
                            hasRows: !!(json.table && json.table.rows),
                            rowCount: json.table && json.table.rows ? json.table.rows.length : 0,
                            hasColumns: !!(json.table && json.table.cols),
                            colCount: json.table && json.table.cols ? json.table.cols.length : 0
                        });
                        
                        if (json.status === 'error') {
                            throw new Error(`Google Sheets API Error: ${json.errors?.[0]?.detailed_message || 'Unknown error'}`);
                        }
                        
                        if (!json.table) {
                            throw new Error('Tidak ada data table dalam response');
                        }
                        
                        if (!json.table.rows || json.table.rows.length === 0) {
                            console.warn(`‚ö†Ô∏è Sheet ${sheetName} kosong atau tidak ada data`);
                            return [];
                        }
                        
                        if (!json.table.cols || json.table.cols.length === 0) {
                            throw new Error('Tidak ada kolom yang ditemukan');
                        }
                        
                        const headers = json.table.cols.map(col => {
                            return col.label || col.id || `Column_${col.index || 0}`;
                        });
                        
                        console.log(`üìã Headers untuk ${sheetName}:`, headers);
                        
                        const data = json.table.rows.map((row, rowIndex) => {
                            const obj = {};
                            headers.forEach((header, colIndex) => {
                                const cell = row.c && row.c[colIndex];
                                let value = '';
                                
                                if (cell) {
                                    value = cell.f || cell.v || '';
                                    if (value !== null && value !== undefined) {
                                        value = value.toString().trim();
                                    }
                                }
                                
                                obj[header] = value;
                            });
                            return obj;
                        }).filter((row, index) => {
                            const hasData = Object.values(row).some(value => 
                                value && value.toString().trim() !== ''
                            );
                            
                            if (!hasData) {
                                console.log(`üóëÔ∏è Filtering out empty row ${index} in ${sheetName}`);
                            }
                            
                            return hasData;
                        });
                        
                        console.log(`‚úÖ Berhasil memuat ${sheetName}: ${data.length} records`);
                        console.log(`üìä Sample data untuk ${sheetName}:`, data.slice(0, 2));
                        
                        return data;
                        
                    } catch (error) {
                        lastError = error;
                        console.warn(`‚ùå Percobaan ${attemptCount} gagal untuk ${sheetName}:`, error.message);
                        
                        if (attemptCount === urls.length) {
                            console.error(`üö® Semua percobaan gagal untuk ${sheetName}:`, error);
                        }
                        continue;
                    }
                }
                
                throw lastError || new Error(`Semua ${urls.length} percobaan URL gagal untuk sheet ${sheetName}`);
                
            } catch (error) {
                console.error(`üí• Fatal error fetching ${sheetName}:`, error);
                showNotification(`Gagal memuat ${sheetName}: ${error.message}`, 'error');
                return [];
            }
        }

        async function fetchLKPDWithGID() {
            try {
                console.log(`üîÑ Memulai fetch LKPD dengan GID: ${SHEET_CONFIG.LKPD_GID}`);
                
                const urls = [
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.LKPD_GID}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.LKPD_GID}&headers=1`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.LKPD_GID}&range=A:F`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.LKPD_GID}&range=A1:F1000`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=LKPD`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=LKPD&headers=1`
                ];

                return await fetchWithMultipleUrls(urls, 'LKPD', (data, headers) => {
                    return data.map((row, rowIndex) => {
                        const obj = {};
                        headers.forEach((header, colIndex) => {
                            const cell = row.c && row.c[colIndex];
                            let value = '';
                            
                            if (cell) {
                                value = cell.f || cell.v || '';
                                if (value !== null && value !== undefined) {
                                    value = value.toString().trim();
                                }
                            }
                            
                            let mappedKey = header;
                            
                            if (colIndex === 0 && (header.toLowerCase().includes('id') || header === 'A' || !header)) {
                                mappedKey = 'ID';
                            } else if (colIndex === 1 && (header.toLowerCase().includes('judul') || header.toLowerCase().includes('title') || header === 'B')) {
                                mappedKey = 'Judul';
                            } else if (colIndex === 2 && (header.toLowerCase().includes('mata') || header.toLowerCase().includes('pelajaran') || header.toLowerCase().includes('subject') || header === 'C')) {
                                mappedKey = 'Mata Pelajaran';
                            } else if (colIndex === 3 && (header.toLowerCase().includes('kelas') || header.toLowerCase().includes('class') || header === 'D')) {
                                mappedKey = 'Kelas';
                            } else if (colIndex === 4 && (header.toLowerCase().includes('link') || header.toLowerCase().includes('url') || header === 'E')) {
                                mappedKey = 'Link';
                            } else if (colIndex === 5 && (header.toLowerCase().includes('deskripsi') || header.toLowerCase().includes('description') || header === 'F')) {
                                mappedKey = 'Deskripsi';
                            }
                            
                            obj[mappedKey] = value;
                            obj[header] = value;
                        });
                        return obj;
                    });
                });
                
            } catch (error) {
                console.error(`üí• Fatal error fetching LKPD:`, error);
                showNotification(`Gagal memuat LKPD: ${error.message}`, 'error');
                return [];
            }
        }

        async function fetchRekapProgresWithGID() {
            try {
                console.log(`üîÑ Memulai fetch RekapProgres dengan GID: ${SHEET_CONFIG.REKAP_PROGRES_GID}`);
                
                const urls = [
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.REKAP_PROGRES_GID}`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.REKAP_PROGRES_GID}&headers=1`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.REKAP_PROGRES_GID}&range=A:E`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.REKAP_PROGRES_GID}&range=A1:E1000`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=RekapProgres`,
                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=RekapProgres&headers=1`
                ];

                return await fetchWithMultipleUrls(urls, 'RekapProgres', (data, headers) => {
                    return data.map((row, rowIndex) => {
                        const obj = {};
                        headers.forEach((header, colIndex) => {
                            const cell = row.c && row.c[colIndex];
                            let value = '';
                            
                            if (cell) {
                                value = cell.f || cell.v || '';
                                if (value !== null && value !== undefined) {
                                    value = value.toString().trim();
                                }
                            }
                            
                            let mappedKey = header;
                            
                            if (colIndex === 0 && (header.toLowerCase().includes('tanggal') || header.toLowerCase().includes('date') || header === 'A')) {
                                mappedKey = 'Tanggal';
                            } else if (colIndex === 1 && (header.toLowerCase().includes('nisn') || header === 'B')) {
                                mappedKey = 'NISN';
                            } else if (colIndex === 2 && (header.toLowerCase().includes('nama') || header.toLowerCase().includes('name') || header === 'C')) {
                                mappedKey = 'Nama';
                            } else if (colIndex === 3 && (header.toLowerCase().includes('kelas') || header.toLowerCase().includes('class') || header === 'D')) {
                                mappedKey = 'Kelas';
                            } else if (colIndex === 4 && (header.toLowerCase().includes('lkpd') || header === 'E')) {
                                mappedKey = 'LKPD';
                            }
                            
                            obj[mappedKey] = value;
                            obj[header] = value;
                        });
                        return obj;
                    });
                });
                
            } catch (error) {
                console.error(`üí• Fatal error fetching RekapProgres:`, error);
                showNotification(`Gagal memuat RekapProgres: ${error.message}`, 'error');
                return [];
            }
        }

        async function fetchWithMultipleUrls(urls, sheetName, dataProcessor) {
            let lastError = null;
            let attemptCount = 0;
            
            for (const url of urls) {
                attemptCount++;
                try {
                    console.log(`üì° ${sheetName} Percobaan ${attemptCount}: ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const text = await response.text();
                    console.log(`üìÑ ${sheetName} Response length:`, text.length);
                    
                    if (text.length < 50) {
                        throw new Error(`Response terlalu pendek untuk ${sheetName}`);
                    }
                    
                    let jsonText = text;
                    
                    if (text.startsWith('/*O_o*/\ngoogle.visualization.Query.setResponse(')) {
                        jsonText = text.substring(47, text.length - 2);
                    } else if (text.includes('google.visualization.Query.setResponse(')) {
                        const start = text.indexOf('google.visualization.Query.setResponse(') + 39;
                        const end = text.lastIndexOf(');');
                        if (end > start) {
                            jsonText = text.substring(start, end);
                        }
                    } else if (text.trim().startsWith('{')) {
                        jsonText = text;
                    }
                    
                    const json = JSON.parse(jsonText);
                    console.log(`üîç ${sheetName} Parsed JSON structure:`, {
                        hasTable: !!json.table,
                        hasRows: !!(json.table && json.table.rows),
                        rowCount: json.table && json.table.rows ? json.table.rows.length : 0,
                        hasColumns: !!(json.table && json.table.cols),
                        colCount: json.table && json.table.cols ? json.table.cols.length : 0
                    });
                    
                    if (json.status === 'error') {
                        throw new Error(`Google Sheets API Error: ${json.errors?.[0]?.detailed_message || 'Unknown error'}`);
                    }
                    
                    if (!json.table || !json.table.rows || json.table.rows.length === 0) {
                        console.warn(`‚ö†Ô∏è Sheet ${sheetName} kosong pada percobaan ${attemptCount}`);
                        continue;
                    }
                    
                    if (!json.table.cols || json.table.cols.length === 0) {
                        throw new Error(`Tidak ada kolom yang ditemukan di ${sheetName}`);
                    }
                    
                    const headers = json.table.cols.map((col, index) => {
                        const label = col.label || col.id || `Column_${index}`;
                        console.log(`üìã ${sheetName} Column ${index}: "${label}"`);
                        return label;
                    });
                    
                    console.log(`üìã ${sheetName} Headers:`, headers);
                    
                    const processedData = dataProcessor(json.table.rows, headers);
                    
                    const data = processedData.filter((row, index) => {
                        const hasData = Object.values(row).some(value => 
                            value && value.toString().trim() !== ''
                        );
                        
                        if (!hasData) {
                            console.log(`üóëÔ∏è Filtering out empty ${sheetName} row ${index}`);
                        }
                        
                        return hasData;
                    });
                    
                    console.log(`‚úÖ Berhasil memuat ${sheetName}: ${data.length} records`);
                    console.log(`üìä Sample ${sheetName} data:`, data.slice(0, 2));
                    
                    if (data.length > 0) {
                        const sampleRow = data[0];
                        console.log(`üîç ${sheetName} Sample row structure:`, Object.keys(sampleRow));
                        console.log(`üîç ${sheetName} Sample row values:`, sampleRow);
                    }
                    
                    return data;
                    
                } catch (error) {
                    lastError = error;
                    console.warn(`‚ùå ${sheetName} Percobaan ${attemptCount} gagal:`, error.message);
                    continue;
                }
            }
            
            throw lastError || new Error(`Semua ${urls.length} percobaan URL gagal untuk ${sheetName}`);
        }

        async function loadAllData() {
            showLoading(true);
            try {
                const [students, teachers, materials, lkpd, rekapProgres] = await Promise.all([
                    fetchGoogleSheetData(SHEET_CONFIG.STUDENTS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.TEACHERS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.MATERIALS_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.LKPD_SHEET),
                    fetchGoogleSheetData(SHEET_CONFIG.REKAP_PROGRES_SHEET)
                ]);
                
                studentsData = students;
                teachersData = teachers;
                materialsData = materials;
                lkpdData = lkpd;
                rekapProgresData = rekapProgres;
                
                console.log(`üìä Data loaded summary:`, {
                    students: studentsData.length,
                    teachers: teachersData.length,
                    materials: materialsData.length,
                    lkpd: lkpdData.length,
                    rekapProgres: rekapProgresData.length
                });
                
                showNotification('Data berhasil dimuat dari Google Sheets');
            } catch (error) {
                showNotification('Gagal memuat data dari Google Sheets', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveProgress(progressData) {
            if (currentRecordCount >= 999) {
                showNotification('Batas maksimum 999 record tercapai. Hubungi administrator.', 'error');
                return;
            }

            showLoading(true);
            try {
                const result = await window.dataSdk.create({
                    student_id: progressData.student_id,
                    student_name: progressData.student_name,
                    class_grade: progressData.class_grade,
                    subject: progressData.subject,
                    material_id: progressData.material_id,
                    material_title: progressData.material_title,
                    progress_type: progressData.progress_type,
                    progress_value: progressData.progress_value,
                    session_duration: progressData.session_duration || 0,
                    timestamp: new Date().toISOString()
                });

                if (result.isOk) {
                    showNotification('Progress berhasil disimpan');
                    
                    // Juga simpan ke RekapProgres lokal jika ini adalah LKPD
                    if (progressData.progress_type === 'lkpd_access') {
                        await saveToRekapProgres(progressData);
                    }
                } else {
                    showNotification('Gagal menyimpan progress', 'error');
                }
            } catch (error) {
                showNotification('Error menyimpan progress', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveToRekapProgres(progressData) {
            try {
                const today = formatDateIndonesia(new Date());
                
                // Cek apakah sudah ada record untuk siswa ini di hari yang sama untuk LKPD yang sama
                const existingRecord = rekapProgresData.find(record => 
                    record.NISN === progressData.student_id &&
                    record.Tanggal === today &&
                    record.LKPD === progressData.material_title
                );
                
                if (existingRecord) {
                    console.log('üìù Record sudah ada untuk siswa ini hari ini:', existingRecord);
                    return;
                }
                
                // Tambah ke array lokal RekapProgres
                const newRecord = {
                    Tanggal: today,
                    NISN: progressData.student_id,
                    Nama: progressData.student_name,
                    Kelas: progressData.class_grade,
                    LKPD: progressData.material_title
                };
                
                rekapProgresData.push(newRecord);
                
                console.log('üìù Data berhasil ditambahkan ke RekapProgres lokal:', newRecord);
                console.log('üìä Total RekapProgres records:', rekapProgresData.length);
                
                // Update tampilan jika user adalah guru
                if (currentUser && currentUser.type === 'teacher') {
                    updateTeacherDashboard();
                }
                
            } catch (error) {
                console.warn('Gagal menyimpan ke RekapProgres lokal:', error);
            }
        }

        // Authentication Functions
        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userType = formData.get('userType');
            const identifier = formData.get('identifier');

            if (!userType) {
                showNotification('Pilih jenis pengguna terlebih dahulu!', 'error');
                return;
            }

            if (!identifier || identifier.trim() === '') {
                showNotification('Masukkan ID pengguna!', 'error');
                return;
            }

            showLoading(true);

            try {
                if (userType === 'student' && studentsData.length === 0) {
                    showNotification('Data siswa belum dimuat. Coba refresh halaman.', 'error');
                    showLoading(false);
                    return;
                }

                if (userType === 'teacher' && teachersData.length === 0) {
                    showNotification('Data guru belum dimuat. Coba refresh halaman.', 'error');
                    showLoading(false);
                    return;
                }

                let user = null;
                let errorMessage = '';
                
                console.log(`üîç Mencari ${userType} dengan ID: "${identifier}"`);
                
                if (userType === 'student') {
                    console.log(`üë• Data siswa tersedia:`, studentsData.length, 'records');
                    console.log(`üìã Sample data siswa:`, studentsData.slice(0, 3));
                    
                    user = studentsData.find(s => {
                        const nisn = s.NISN || s.nisn || s.Nisn || s['NISN'] || '';
                        return nisn && nisn.toString().trim() === identifier.toString().trim();
                    });
                    
                    if (user) {
                        user.type = 'student';
                        user.id = user.NISN || user.nisn || user.Nisn || user['NISN'];
                        user.name = user.Nama || user.nama || user.Name || user['Nama'];
                        user.class = user.Kelas || user.kelas || user.Class || user['Kelas'];
                        console.log(`‚úÖ Siswa ditemukan:`, user);
                    } else {
                        const similarStudents = studentsData.filter(s => {
                            const nisn = s.NISN || s.nisn || s.Nisn || s['NISN'] || '';
                            return nisn && nisn.toString().includes(identifier);
                        });
                        
                        console.log(`üîç Siswa dengan ID mirip:`, similarStudents);
                        
                        if (similarStudents.length > 0) {
                            const suggestions = similarStudents.slice(0, 3).map(s => 
                                s.NISN || s.nisn || s.Nisn || s['NISN']
                            ).join(', ');
                            errorMessage = `NISN "${identifier}" tidak ditemukan. Mungkin maksud Anda: ${suggestions}`;
                        } else {
                            const availableNISNs = studentsData.map(s => s.NISN || s.nisn || s.Nisn || s['NISN']).filter(Boolean);
                            if (availableNISNs.length > 0) {
                                const suggestions = availableNISNs.slice(0, 3).join(', ');
                                errorMessage = `NISN "${identifier}" tidak terdaftar. Contoh NISN yang tersedia: ${suggestions}`;
                            } else {
                                errorMessage = `NISN "${identifier}" tidak terdaftar. Pastikan NISN sudah benar dan terdaftar di Google Sheets.`;
                            }
                        }
                        
                        console.log(`‚ùå NISN tidak ditemukan. Available NISNs:`, 
                            studentsData.map(s => s.NISN || s.nisn || s.Nisn || s['NISN']).filter(Boolean)
                        );
                    }
                } else if (userType === 'teacher') {
                    console.log(`üë®‚Äçüè´ Data guru tersedia:`, teachersData.length, 'records');
                    console.log(`üìã Sample data guru:`, teachersData.slice(0, 3));
                    console.log(`üîç Struktur kolom guru:`, teachersData.length > 0 ? Object.keys(teachersData[0]) : 'Tidak ada data');
                    
                    user = teachersData.find(t => {
                        console.log(`üîç Checking teacher record:`, t);
                        
                        const allKeys = Object.keys(t);
                        console.log(`üîç Available fields:`, allKeys);
                        
                        const possibleNipFields = [
                            'NIP', 'nip', 'Nip', 'ID', 'id', 'Id',
                            ...allKeys.filter(key => 
                                key.toLowerCase().includes('nip') || 
                                key.toLowerCase().includes('id') ||
                                key.toLowerCase().includes('pegawai')
                            )
                        ];
                        
                        console.log(`üîç Possible NIP fields:`, possibleNipFields);
                        
                        for (const field of possibleNipFields) {
                            if (t.hasOwnProperty(field)) {
                                const fieldValue = t[field];
                                if (fieldValue !== undefined && fieldValue !== null && fieldValue !== '') {
                                    const nip = fieldValue.toString().trim();
                                    const inputNip = identifier.toString().trim();
                                    
                                    console.log(`üîç Comparing field "${field}": "${nip}" vs "${inputNip}"`);
                                    
                                    const exactMatch = nip === inputNip;
                                    const normalizedMatch = nip.replace(/[\s\-\.\,]/g, '') === inputNip.replace(/[\s\-\.\,]/g, '');
                                    const containsMatch = nip.includes(inputNip) && inputNip.length >= 3;
                                    const reverseContainsMatch = inputNip.includes(nip) && nip.length >= 3;
                                    
                                    if (exactMatch || normalizedMatch || containsMatch || reverseContainsMatch) {
                                        console.log(`‚úÖ Match found in field "${field}": ${nip}`);
                                        return true;
                                    }
                                }
                            }
                        }
                        
                        for (const [key, value] of Object.entries(t)) {
                            if (value !== undefined && value !== null && value !== '') {
                                const strValue = value.toString().trim();
                                const inputStr = identifier.toString().trim();
                                
                                if (strValue === inputStr) {
                                    console.log(`‚úÖ Exact match found in field "${key}": ${strValue}`);
                                    return true;
                                }
                                
                                const normalizedValue = strValue.replace(/[\s\-\.\,]/g, '');
                                const normalizedInput = inputStr.replace(/[\s\-\.\,]/g, '');
                                if (normalizedValue === normalizedInput && normalizedInput.length >= 3) {
                                    console.log(`‚úÖ Normalized match found in field "${key}": ${strValue}`);
                                    return true;
                                }
                            }
                        }
                        
                        return false;
                    });
                    
                    if (user) {
                        user.type = 'teacher';
                        
                        const allKeys = Object.keys(user);
                        
                        user.id = '';
                        const nipFields = allKeys.filter(key => key.toLowerCase().includes('nip'));
                        for (const field of nipFields) {
                            if (user[field] && user[field].toString().trim() !== '') {
                                user.id = user[field].toString().trim();
                                break;
                            }
                        }
                        if (!user.id) {
                            user.id = user.NIP || user.nip || user.Nip || user.ID || user.id || identifier;
                        }
                        
                        user.name = '';
                        const namaFields = allKeys.filter(key => key.toLowerCase().includes('nama') || key.toLowerCase().includes('name'));
                        for (const field of namaFields) {
                            if (user[field] && user[field].toString().trim() !== '') {
                                user.name = user[field].toString().trim();
                                break;
                            }
                        }
                        if (!user.name) {
                            user.name = user.Nama || user.nama || user.Name || user.name || 'Guru';
                        }
                        
                        user.subject = '';
                        const subjectFields = allKeys.filter(key => 
                            key.toLowerCase().includes('pelajaran') || 
                            key.toLowerCase().includes('subject') ||
                            key.toLowerCase().includes('mapel')
                        );
                        for (const field of subjectFields) {
                            if (user[field] && user[field].toString().trim() !== '') {
                                user.subject = user[field].toString().trim();
                                break;
                            }
                        }
                        if (!user.subject) {
                            user.subject = user['Mata Pelajaran'] || user.MataPelajaran || user.Subject || user.subject || user.Mapel || user.mapel || 'Umum';
                        }
                        
                        user.email = '';
                        const emailFields = allKeys.filter(key => key.toLowerCase().includes('email'));
                        for (const field of emailFields) {
                            if (user[field] && user[field].toString().trim() !== '') {
                                user.email = user[field].toString().trim();
                                break;
                            }
                        }
                        if (!user.email) {
                            user.email = user.Email || user.email || user.EMAIL || '';
                        }
                        
                        console.log(`‚úÖ Guru ditemukan dan diproses:`, {
                            id: user.id,
                            name: user.name,
                            subject: user.subject,
                            email: user.email,
                            originalData: user,
                            availableFields: Object.keys(user)
                        });
                    } else {
                        console.log(`‚ùå Guru tidak ditemukan. Analyzing available data...`);
                        console.log(`üîç Input identifier: "${identifier}"`);
                        console.log(`üìä Total teacher records: ${teachersData.length}`);
                        
                        const availableData = teachersData.map((t, index) => {
                            const analysis = {
                                index: index + 1,
                                fields: Object.keys(t),
                                values: {}
                            };
                            
                            Object.entries(t).forEach(([key, value]) => {
                                if (value !== undefined && value !== null && value !== '') {
                                    analysis.values[key] = value.toString().trim();
                                }
                            });
                            
                            return analysis;
                        });
                        
                        console.log(`üìä Available teacher data analysis:`, availableData);
                        
                        if (teachersData.length > 0) {
                            console.log(`üîç First 3 teacher records:`, teachersData.slice(0, 3));
                            console.log(`üîç All possible values in first record:`, Object.values(teachersData[0]));
                        }
                        
                        const similarTeachers = teachersData.filter(t => {
                            const allValues = Object.values(t).join(' ').toLowerCase();
                            return allValues.includes(identifier.toLowerCase());
                        });
                        
                        if (similarTeachers.length > 0) {
                            console.log(`üîç Similar teachers found:`, similarTeachers);
                            const suggestions = similarTeachers.slice(0, 3).map(t => {
                                const allKeys = Object.keys(t);
                                const nipField = allKeys.find(key => 
                                    key.toLowerCase().includes('nip') && t[key] && t[key].toString().trim() !== ''
                                );
                                return nipField ? t[nipField] : 'ID tidak ditemukan';
                            }).join(', ');
                            errorMessage = `NIP "${identifier}" tidak ditemukan. Data mirip: ${suggestions}`;
                        } else {
                            const availableIds = teachersData.map(t => {
                                const allKeys = Object.keys(t);
                                const nipField = allKeys.find(key => 
                                    key.toLowerCase().includes('nip') && t[key] && t[key].toString().trim() !== ''
                                );
                                return nipField ? t[nipField] : null;
                            }).filter(Boolean);
                            
                            if (availableIds.length > 0) {
                                const suggestions = availableIds.slice(0, 3).join(', ');
                                errorMessage = `NIP "${identifier}" tidak terdaftar. Contoh NIP tersedia: ${suggestions}`;
                            } else {
                                const sampleFields = teachersData.length > 0 ? Object.keys(teachersData[0]).join(', ') : 'Tidak ada data';
                                errorMessage = `NIP "${identifier}" tidak terdaftar. Struktur data guru: ${sampleFields}. Pastikan data sudah benar di Google Sheets.`;
                            }
                        }
                    }
                }

                if (user) {
                    currentUser = user;
                    showDashboard();
                    showNotification(`Selamat datang, ${user.name}!`);
                } else {
                    showNotification(errorMessage, 'error');
                    showLoginHelp();
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Terjadi kesalahan saat login. Coba lagi dalam beberapa saat.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showLoginHelp() {
            const helpDiv = document.getElementById('login-help');
            if (helpDiv) {
                helpDiv.classList.remove('hidden');
                setTimeout(() => {
                    helpDiv.classList.add('hidden');
                }, 10000);
            }
        }

        function showDebugInfo() {
            const debugModal = document.createElement('div');
            debugModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            debugModal.innerHTML = `
                <div class="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">üîç Debug Info - Analisis Koneksi Google Sheets</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Status Koneksi -->
                        <div class="p-4 border rounded-lg">
                            <h4 class="font-semibold text-blue-600 mb-2">üìä Status Koneksi Google Sheets</h4>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                                <div class="text-center p-2 rounded ${studentsData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${studentsData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>DataSiswa</div>
                                    <div class="text-xs">${studentsData.length} records</div>
                                </div>
                                <div class="text-center p-2 rounded ${teachersData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${teachersData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>DataGuru</div>
                                    <div class="text-xs">${teachersData.length} records</div>
                                </div>
                                <div class="text-center p-2 rounded ${materialsData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${materialsData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>MateriPelajaran</div>
                                    <div class="text-xs">${materialsData.length} records</div>
                                </div>
                                <div class="text-center p-2 rounded ${lkpdData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${lkpdData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>LKPD</div>
                                    <div class="text-xs">${lkpdData.length} records</div>
                                </div>
                                <div class="text-center p-2 rounded ${rekapProgresData.length > 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}">
                                    <div class="font-semibold">${rekapProgresData.length > 0 ? '‚úÖ' : '‚ùå'}</div>
                                    <div>RekapProgres</div>
                                    <div class="text-xs">${rekapProgresData.length} records</div>
                                </div>
                            </div>
                        </div>

                        <!-- Data RekapProgres -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üìä Data RekapProgres (${rekapProgresData.length} records)</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs max-h-32 overflow-y-auto font-mono">
                                ${rekapProgresData.length > 0 ? 
                                    rekapProgresData.slice(0, 5).map(r => 
                                        `Tanggal: ${r.Tanggal || 'N/A'} | NISN: ${r.NISN || 'N/A'} | Nama: ${r.Nama || 'N/A'} | Kelas: ${r.Kelas || 'N/A'} | LKPD: ${r.LKPD || 'N/A'}`
                                    ).join('<br>') + (rekapProgresData.length > 5 ? '<br>... dan ' + (rekapProgresData.length - 5) + ' lainnya' : '') +
                                    '<br><br><strong>üîç Struktur kolom RekapProgres:</strong><br>' + 
                                    (rekapProgresData.length > 0 ? Object.keys(rekapProgresData[0]).join(', ') : 'Tidak ada data') +
                                    '<br><br><strong>üîó URL RekapProgres yang digunakan:</strong><br>' +
                                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.REKAP_PROGRES_GID}`
                                    : '<span class="text-red-600">‚ùå Tidak ada data RekapProgres yang dimuat</span>'
                                }
                            </div>
                        </div>

                        <!-- Data Siswa -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üë• Data Siswa (${studentsData.length} records)</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs max-h-32 overflow-y-auto font-mono">
                                ${studentsData.length > 0 ? 
                                    studentsData.slice(0, 5).map(s => 
                                        `NISN: ${s.NISN || 'N/A'} | Nama: ${s.Nama || 'N/A'} | Kelas: ${s.Kelas || 'N/A'}`
                                    ).join('<br>') + (studentsData.length > 5 ? '<br>... dan ' + (studentsData.length - 5) + ' lainnya' : '')
                                    : '<span class="text-red-600">‚ùå Tidak ada data siswa yang dimuat</span>'
                                }
                            </div>
                        </div>

                        <!-- Data Guru -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üë®‚Äçüè´ Data Guru (${teachersData.length} records)</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs max-h-32 overflow-y-auto font-mono">
                                ${teachersData.length > 0 ? 
                                    teachersData.slice(0, 5).map(t => 
                                        `NIP: ${t.NIP || 'N/A'} | Nama: ${t.Nama || 'N/A'} | Mapel: ${t['Mata Pelajaran'] || 'N/A'} | Email: ${t.Email || 'N/A'}`
                                    ).join('<br>') + (teachersData.length > 5 ? '<br>... dan ' + (teachersData.length - 5) + ' lainnya' : '') +
                                    '<br><br><strong>üîç Struktur kolom guru:</strong><br>' + 
                                    (teachersData.length > 0 ? Object.keys(teachersData[0]).join(', ') : 'Tidak ada data')
                                    : '<span class="text-red-600">‚ùå Tidak ada data guru yang dimuat</span>'
                                }
                            </div>
                        </div>

                        <!-- Data LKPD -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üìù Data LKPD (${lkpdData.length} records)</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs max-h-32 overflow-y-auto font-mono">
                                ${lkpdData.length > 0 ? 
                                    lkpdData.slice(0, 3).map(l => {
                                        const id = l.ID || l.id || l.Id || 'N/A';
                                        const judul = l.Judul || l.judul || l.Title || 'N/A';
                                        const mapel = l['Mata Pelajaran'] || l['mata_pelajaran'] || l.MataPelajaran || l.Subject || 'N/A';
                                        const kelas = l.Kelas || l.kelas || l.Class || 'N/A';
                                        const link = l.Link || l.link || 'N/A';
                                        const deskripsi = (l.Deskripsi || l.deskripsi || 'N/A').substring(0, 30) + '...';
                                        return `ID: ${id} | Judul: ${judul} | Mapel: ${mapel} | Kelas: ${kelas} | Link: ${link} | Desc: ${deskripsi}`;
                                    }).join('<br>') + (lkpdData.length > 3 ? '<br>... dan ' + (lkpdData.length - 3) + ' lainnya' : '') +
                                    '<br><br><strong>üîç Struktur kolom LKPD:</strong><br>' + 
                                    (lkpdData.length > 0 ? Object.keys(lkpdData[0]).join(', ') : 'Tidak ada data') +
                                    '<br><br><strong>üîó URL LKPD yang digunakan:</strong><br>' +
                                    `https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_CONFIG.LKPD_GID}`
                                    : '<span class="text-red-600">‚ùå Tidak ada data LKPD yang dimuat</span>'
                                }
                            </div>
                        </div>

                        <!-- URL Testing -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold text-blue-600 mb-2">üîó URL Google Sheets yang Digunakan</h4>
                            <div class="bg-gray-50 p-3 rounded text-xs">
                                <p class="mb-2"><strong>Sheet ID:</strong> ${SHEET_CONFIG.SHEET_ID}</p>
                                <p class="mb-2"><strong>LKPD GID:</strong> ${SHEET_CONFIG.LKPD_GID}</p>
                                <p class="mb-2"><strong>RekapProgres GID:</strong> ${SHEET_CONFIG.REKAP_PROGRES_GID}</p>
                                <p class="mb-2"><strong>Base URL:</strong></p>
                                <p class="font-mono text-blue-600 break-all">
                                    https://docs.google.com/spreadsheets/d/${SHEET_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=[NAMA_SHEET]
                                </p>
                            </div>
                        </div>

                        <!-- Refresh Button -->
                        <div class="text-center">
                            <button onclick="this.closest('.fixed').remove(); loadAllData();" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                üîÑ Refresh Data Sekarang
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(debugModal);
        }

        function logout() {
            currentUser = null;
            showLoginScreen();
            showNotification('Anda telah logout');
        }

        // UI Functions
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard-screen').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            updateDashboard();
        }

        function updateDashboard() {
            if (!currentUser) return;

            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-info').textContent = 
                currentUser.type === 'student' ? `Kelas ${currentUser.class}` : `Guru ${currentUser.subject}`;

            if (currentUser.type === 'student') {
                showStudentDashboard();
            } else {
                showTeacherDashboard();
            }
        }

        function showStudentDashboard() {
            const studentClass = currentUser.class ? currentUser.class.toString().trim() : '';
            const classNumber = studentClass.charAt(0);
            console.log(`üë• Student dashboard - Full Class: "${studentClass}", Class Number: "${classNumber}"`);
            
            const availableMaterials = materialsData.filter(m => {
                const kelas = (m.Kelas || m.kelas || m.Class || m.class || m['Kelas'] || '').toString().trim();
                const match = kelas === studentClass || kelas === classNumber || kelas.includes(classNumber);
                console.log(`üìö Material class check: "${kelas}" vs "${studentClass}"/"${classNumber}" = ${match}`);
                return match;
            });
            
            const availableLKPD = lkpdData.filter(l => {
                const kelas = (l.Kelas || l.kelas || l.Class || l.class || l['Kelas'] || '').toString().trim();
                const match = kelas === studentClass || kelas === classNumber || kelas.includes(classNumber) || 
                             studentClass.includes(kelas) || classNumber === kelas;
                console.log(`üìù LKPD class check: "${kelas}" vs "${studentClass}"/"${classNumber}" = ${match}`);
                return match;
            });

            console.log(`üìö Available materials for class ${studentClass}:`, availableMaterials.length);
            console.log(`üìù Available LKPD for class ${studentClass}:`, availableLKPD.length);

            renderMaterials(availableMaterials);
            renderLKPD(availableLKPD);
            updateStudentProgress();
        }

        function showTeacherDashboard() {
            const teacherSubject = currentUser.subject || '';
            console.log(`üë®‚Äçüè´ Teacher dashboard - Subject: ${teacherSubject}`);
            
            const subjectMaterials = materialsData.filter(m => {
                const mataPelajaran = m['Mata Pelajaran'] || m['mata_pelajaran'] || m.MataPelajaran || m.Subject || m.subject || '';
                return mataPelajaran === teacherSubject;
            });
            
            const subjectLKPD = lkpdData.filter(l => {
                const mataPelajaran = l['Mata Pelajaran'] || l['mata_pelajaran'] || l.MataPelajaran || l.Subject || l.subject || '';
                return mataPelajaran === teacherSubject;
            });

            console.log(`üìö Available materials for subject ${teacherSubject}:`, subjectMaterials.length);
            console.log(`üìù Available LKPD for subject ${teacherSubject}:`, subjectLKPD.length);

            renderMaterials(subjectMaterials);
            renderTeacherLKPD(subjectLKPD);
            renderTeacherProgress();
        }

        function updateTeacherDashboard() {
            if (currentUser && currentUser.type === 'teacher') {
                showTeacherDashboard();
            }
        }

        function renderMaterials(materials) {
            const container = document.getElementById('materials-container');
            container.innerHTML = '';

            if (materials.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada materi tersedia</p>';
                return;
            }

            materials.forEach(material => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover fade-in';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${material.Judul}</h3>
                            <p class="text-sm text-gray-600 mb-2">${material.Deskripsi}</p>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${material['Mata Pelajaran']}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${material.Kelas}</span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">${material.Tipe}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            ${material.Tipe === 'video' ? 'üé•' : 'üìÑ'}
                        </div>
                    </div>
                    <button onclick="accessMaterial('${material.ID}', '${material.Judul}', '${material.Link}', '${material['Mata Pelajaran']}')" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        Akses Materi
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderLKPD(lkpdList) {
            const container = document.getElementById('lkpd-container');
            container.innerHTML = '';

            console.log(`üìù Rendering LKPD:`, lkpdList.length, 'items');

            if (lkpdList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada LKPD tersedia</p>';
                return;
            }

            lkpdList.forEach((lkpd, index) => {
                const id = lkpd.ID || lkpd.id || `lkpd-${index + 1}`;
                const judul = lkpd.Judul || lkpd.judul || 'LKPD Tanpa Judul';
                const mataPelajaran = lkpd['Mata Pelajaran'] || lkpd.MataPelajaran || lkpd.Subject || 'Umum';
                const kelas = lkpd.Kelas || lkpd.kelas || '-';
                const link = lkpd.Link || lkpd.link || '';
                const deskripsi = lkpd.Deskripsi || lkpd.deskripsi || 'Tidak ada deskripsi';

                let isValidLink = false;
                let normalizedLink = '';
                let linkStatus = '';
                
                if (link && link.trim() !== '' && link !== '#' && link.toLowerCase() !== 'null') {
                    const trimmedLink = link.trim();
                    
                    if (trimmedLink.match(/^https?:\/\/.+/)) {
                        normalizedLink = trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Valid HTTP/HTTPS';
                    } else if (trimmedLink.match(/^www\..+/)) {
                        normalizedLink = 'https://' + trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Valid WWW';
                    } else if (trimmedLink.includes('.') && trimmedLink.length > 3 && !trimmedLink.includes(' ')) {
                        normalizedLink = 'https://' + trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Valid domain';
                    } else if (trimmedLink.startsWith('//')) {
                        normalizedLink = 'https:' + trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Protocol-relative';
                    } else if (trimmedLink.length > 5 && !trimmedLink.includes(' ')) {
                        normalizedLink = 'https://' + trimmedLink;
                        isValidLink = true;
                        linkStatus = 'Kemungkinan link';
                    }
                } else {
                    linkStatus = 'Link kosong atau tidak valid';
                }

                const buttonId = `lkpd-btn-${index}`;

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover fade-in';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded mr-2">ID: ${id}</span>
                                <h3 class="text-lg font-semibold text-gray-800">${judul}</h3>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">${deskripsi}</p>
                            <div class="flex items-center space-x-2 text-sm text-gray-500 flex-wrap gap-2 mb-3">
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">${mataPelajaran}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${kelas}</span>
                                ${isValidLink ? 
                                    '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">‚úì Link Aktif</span>' : 
                                    '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">‚úó Link Tidak Tersedia</span>'
                                }
                            </div>
                            ${isValidLink ? `
                                <div class="mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <p class="text-xs text-blue-600 font-medium mb-1">üîó Link LKPD:</p>
                                    <a href="${normalizedLink}" target="_blank" rel="noopener noreferrer" 
                                       class="text-xs text-blue-700 hover:text-blue-900 break-all underline">
                                        ${normalizedLink}
                                    </a>
                                    <p class="text-xs text-green-600 mt-1">Status: ${linkStatus}</p>
                                </div>
                            ` : `
                                <div class="mt-2 p-3 bg-red-50 rounded-lg border border-red-200">
                                    <p class="text-xs text-red-600 font-medium">‚ùå Link tidak tersedia atau tidak valid</p>
                                    ${link ? `<p class="text-xs text-gray-500 mt-1">Link asli: ${link}</p>` : ''}
                                </div>
                            `}
                        </div>
                        <div class="ml-4 text-2xl">üìù</div>
                    </div>
                    
                    ${isValidLink ? `
                        <div class="space-y-2">
                            <button id="${buttonId}" 
                                    data-lkpd-id="${id}"
                                    data-lkpd-title="${judul}"
                                    data-lkpd-link="${normalizedLink}"
                                    data-lkpd-subject="${mataPelajaran}"
                                    class="w-full bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 active:bg-orange-800 transition-colors font-medium">
                                üöÄ Kerjakan LKPD
                            </button>
                            <button onclick="window.open('${normalizedLink}', '_blank', 'noopener,noreferrer')" 
                                    class="w-full py-2 px-4 rounded-lg text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                üîó Buka Link Langsung
                            </button>
                        </div>
                    ` : `
                        <button disabled 
                                class="w-full bg-gray-300 text-gray-500 py-3 px-4 rounded-lg cursor-not-allowed font-medium">
                            ‚ùå Link Tidak Tersedia
                        </button>
                    `}
                `;
                container.appendChild(card);

                if (isValidLink) {
                    const button = document.getElementById(buttonId);
                    if (button) {
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log(`üñ±Ô∏è Button clicked for LKPD: ${judul}`);
                            accessLKPD(id, judul, normalizedLink, mataPelajaran);
                        });
                    }
                }
            });

            container.addEventListener('click', function(e) {
                const button = e.target.closest('button[data-lkpd-id]');
                if (button && !button.disabled) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const id = button.getAttribute('data-lkpd-id');
                    const title = button.getAttribute('data-lkpd-title');
                    const link = button.getAttribute('data-lkpd-link');
                    const subject = button.getAttribute('data-lkpd-subject');
                    
                    console.log(`üéØ Global click handler for LKPD: ${title}`);
                    accessLKPD(id, title, link, subject);
                }
            });
        }

        function renderTeacherLKPD(lkpdList) {
            const container = document.getElementById('lkpd-container');
            container.innerHTML = '';

            console.log(`üìù Rendering Teacher LKPD:`, lkpdList.length, 'items');

            if (lkpdList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada LKPD tersedia untuk mata pelajaran Anda</p>';
                return;
            }

            lkpdList.forEach((lkpd, index) => {
                const id = lkpd.ID || lkpd.id || `lkpd-${index + 1}`;
                const judul = lkpd.Judul || lkpd.judul || 'LKPD Tanpa Judul';
                const mataPelajaran = lkpd['Mata Pelajaran'] || lkpd.MataPelajaran || lkpd.Subject || 'Umum';
                const kelas = lkpd.Kelas || lkpd.kelas || '-';
                const link = lkpd.Link || lkpd.link || '';
                const deskripsi = lkpd.Deskripsi || lkpd.deskripsi || 'Tidak ada deskripsi';

                // Cari siswa yang sudah mengerjakan LKPD ini
                const studentsWhoWorked = rekapProgresData.filter(record => 
                    record.LKPD === judul || record.LKPD === id
                );

                const totalStudents = studentsWhoWorked.length;
                const uniqueClasses = [...new Set(studentsWhoWorked.map(s => s.Kelas))].length;
                const latestDate = studentsWhoWorked.length > 0 ? 
                    studentsWhoWorked.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal))[0].Tanggal : null;

                // Preview 5 siswa terakhir
                const recentStudents = studentsWhoWorked
                    .sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal))
                    .slice(0, 5);

                let isValidLink = false;
                let normalizedLink = '';
                
                if (link && link.trim() !== '' && link !== '#' && link.toLowerCase() !== 'null') {
                    const trimmedLink = link.trim();
                    if (trimmedLink.match(/^https?:\/\/.+/)) {
                        normalizedLink = trimmedLink;
                        isValidLink = true;
                    } else if (trimmedLink.match(/^www\..+/)) {
                        normalizedLink = 'https://' + trimmedLink;
                        isValidLink = true;
                    } else if (trimmedLink.includes('.') && trimmedLink.length > 3 && !trimmedLink.includes(' ')) {
                        normalizedLink = 'https://' + trimmedLink;
                        isValidLink = true;
                    }
                }

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 card-hover fade-in';
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded mr-2">ID: ${id}</span>
                                <h3 class="text-lg font-semibold text-gray-800">${judul}</h3>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">${deskripsi}</p>
                            <div class="flex items-center space-x-2 text-sm text-gray-500 flex-wrap gap-2 mb-3">
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">${mataPelajaran}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Kelas ${kelas}</span>
                                ${totalStudents > 0 ? 
                                    `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">üë• ${totalStudents} siswa mengerjakan</span>` : 
                                    '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">üë• Belum ada yang mengerjakan</span>'
                                }
                            </div>
                            
                            ${totalStudents > 0 ? `
                                <div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-sm font-semibold text-green-800">üìä Status Pengerjaan</h4>
                                        <span class="text-xs text-green-600">${uniqueClasses} kelas berbeda</span>
                                    </div>
                                    <div class="text-xs text-green-700 space-y-1">
                                        <div class="flex justify-between">
                                            <span>Total siswa:</span>
                                            <span class="font-semibold">${totalStudents}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Terakhir dikerjakan:</span>
                                            <span class="font-semibold">${latestDate || '-'}</span>
                                        </div>
                                    </div>
                                    
                                    ${recentStudents.length > 0 ? `
                                        <div class="mt-2 pt-2 border-t border-green-200">
                                            <p class="text-xs font-semibold text-green-800 mb-1">5 Siswa Terakhir:</p>
                                            <div class="space-y-1">
                                                ${recentStudents.map(student => `
                                                    <div class="flex justify-between text-xs text-green-700">
                                                        <span>${student.NISN} - ${student.Nama}</span>
                                                        <span class="text-green-600">${student.Tanggal}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <p class="text-sm text-gray-600">üìä Belum ada siswa yang mengerjakan LKPD ini</p>
                                </div>
                            `}

                            ${isValidLink ? `
                                <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <p class="text-xs text-blue-600 font-medium mb-1">üîó Link LKPD:</p>
                                    <a href="${normalizedLink}" target="_blank" rel="noopener noreferrer" 
                                       class="text-xs text-blue-700 hover:text-blue-900 break-all underline">
                                        ${normalizedLink}
                                    </a>
                                </div>
                            ` : `
                                <div class="mt-3 p-3 bg-red-50 rounded-lg border border-red-200">
                                    <p class="text-xs text-red-600 font-medium">‚ùå Link tidak tersedia</p>
                                </div>
                            `}
                        </div>
                        <div class="ml-4 text-2xl">üìù</div>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="showLKPDDetail('${id}', '${judul}')" 
                                class="w-full py-3 px-4 rounded-lg font-medium transition-colors ${totalStudents > 0 ? 
                                    'bg-green-600 text-white hover:bg-green-700' : 
                                    'bg-gray-300 text-gray-600 hover:bg-gray-400'
                                }">
                            üìä Detail Pengerjaan (${totalStudents} siswa)
                        </button>
                        ${isValidLink ? `
                            <button onclick="window.open('${normalizedLink}', '_blank', 'noopener,noreferrer')" 
                                    class="w-full py-2 px-4 rounded-lg text-sm bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                                üîó Buka Link LKPD
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function showLKPDDetail(lkpdId, lkpdTitle) {
            // Cari semua siswa yang mengerjakan LKPD ini
            const studentsWhoWorked = rekapProgresData.filter(record => 
                record.LKPD === lkpdTitle || record.LKPD === lkpdId
            );

            if (studentsWhoWorked.length === 0) {
                showNotification('Belum ada siswa yang mengerjakan LKPD ini', 'info');
                return;
            }

            // Sort berdasarkan tanggal terbaru
            const sortedStudents = studentsWhoWorked.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal));

            // Statistik
            const totalStudents = sortedStudents.length;
            const uniqueClasses = [...new Set(sortedStudents.map(s => s.Kelas))];
            const latestDate = sortedStudents[0].Tanggal;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">üìä Detail Pengerjaan LKPD</h3>
                                <p class="text-gray-600 font-medium">${lkpdTitle}</p>
                                <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">üë• ${totalStudents} siswa</span>
                                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded">üè´ ${uniqueClasses.length} kelas</span>
                                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">üìÖ Terakhir: ${latestDate}</span>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">No</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">NISN</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Kelas</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Tanggal</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedStudents.map((student, index) => `
                                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-gray-700">${index + 1}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm font-medium text-gray-800">${student.NISN}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${student.Nama}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">
                                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${student.Kelas}</span>
                                            </td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-gray-700">${student.Tanggal}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">
                                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">‚úÖ Dikerjakan</span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 flex justify-center">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function accessMaterial(materialId, title, link, subject) {
            if (currentUser && currentUser.type === 'student') {
                await saveProgress({
                    student_id: currentUser.id,
                    student_name: currentUser.name,
                    class_grade: currentUser.class,
                    subject: subject,
                    material_id: materialId,
                    material_title: title,
                    progress_type: 'material_access',
                    progress_value: 1,
                    session_duration: 0
                });
            }
            
            window.open(link, '_blank', 'noopener,noreferrer');
        }

        async function accessLKPD(lkpdId, title, link, subject) {
            console.log(`üöÄ accessLKPD called with:`, { lkpdId, title, link, subject });
            
            if (!link || link === '#' || link.trim() === '') {
                showNotification('Link LKPD tidak tersedia atau tidak valid', 'error');
                console.error('‚ùå Invalid link:', link);
                return;
            }

            let normalizedLink = link.trim();
            
            if (!normalizedLink.match(/^https?:\/\//)) {
                if (normalizedLink.startsWith('www.')) {
                    normalizedLink = 'https://' + normalizedLink;
                } else if (normalizedLink.includes('.') && !normalizedLink.includes(' ')) {
                    normalizedLink = 'https://' + normalizedLink;
                }
            }

            console.log(`üîó Final normalized link: ${normalizedLink}`);

            if (currentUser && currentUser.type === 'student') {
                try {
                    await saveProgress({
                        student_id: currentUser.id,
                        student_name: currentUser.name,
                        class_grade: currentUser.class,
                        subject: subject,
                        material_id: lkpdId,
                        material_title: title,
                        progress_type: 'lkpd_access',
                        progress_value: 1,
                        session_duration: 0
                    });
                    console.log('‚úÖ Progress saved successfully');
                } catch (progressError) {
                    console.warn('‚ö†Ô∏è Failed to save progress:', progressError);
                }
            }
            
            try {
                console.log(`üåê Attempting to open: ${normalizedLink}`);
                
                const newWindow = window.open(normalizedLink, '_blank', 'noopener,noreferrer,width=1200,height=800');
                
                if (newWindow) {
                    console.log('‚úÖ Link opened successfully with window.open');
                    showNotification(`Membuka LKPD: ${title}`);
                } else {
                    console.warn('‚ö†Ô∏è Popup blocked, trying alternative method');
                    
                    const tempLink = document.createElement('a');
                    tempLink.href = normalizedLink;
                    tempLink.target = '_blank';
                    tempLink.rel = 'noopener noreferrer';
                    tempLink.style.display = 'none';
                    document.body.appendChild(tempLink);
                    tempLink.click();
                    document.body.removeChild(tempLink);
                    
                    console.log('‚úÖ Link opened with temporary anchor method');
                    showNotification(`Membuka LKPD: ${title} (popup mungkin diblokir)`);
                }
                
            } catch (error) {
                console.error('‚ùå Error opening LKPD:', error);
                showNotification(`Gagal membuka LKPD: ${error.message}`, 'error');
                showLinkFallback(normalizedLink, title);
            }
        }

        function showLinkFallback(link, title) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full p-6">
                    <h3 class="text-lg font-bold mb-4">üîó Link LKPD</h3>
                    <p class="text-gray-600 mb-4">Silakan klik link di bawah untuk membuka LKPD:</p>
                    <div class="mb-4">
                        <p class="font-semibold text-gray-800 mb-2">${title}</p>
                        <a href="${link}" target="_blank" rel="noopener noreferrer" 
                           class="block w-full p-3 bg-blue-50 border border-blue-200 rounded text-blue-600 hover:bg-blue-100 transition-colors break-all">
                            ${link}
                        </a>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="window.open('${link}', '_blank'); this.closest('.fixed').remove();" 
                                class="flex-1 bg-orange-600 text-white py-2 px-4 rounded hover:bg-orange-700">
                            Buka Link
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }, 30000);
        }

        function updateStudentProgress() {
            const studentProgress = progressData.filter(p => p.student_id === currentUser.id);
            const container = document.getElementById('progress-container');
            
            if (studentProgress.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada aktivitas pembelajaran</p>';
                return;
            }

            const progressBySubject = {};
            studentProgress.forEach(p => {
                if (!progressBySubject[p.subject]) {
                    progressBySubject[p.subject] = { materials: 0, lkpd: 0 };
                }
                if (p.progress_type === 'material_access') {
                    progressBySubject[p.subject].materials++;
                } else if (p.progress_type === 'lkpd_access') {
                    progressBySubject[p.subject].lkpd++;
                }
            });

            container.innerHTML = Object.entries(progressBySubject).map(([subject, progress]) => `
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h4 class="font-semibold text-gray-800 mb-2">${subject}</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Materi diakses:</span>
                            <span class="font-semibold">${progress.materials}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>LKPD dikerjakan:</span>
                            <span class="font-semibold">${progress.lkpd}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTeacherProgress() {
            const container = document.getElementById('progress-container');
            
            // Filter data RekapProgres berdasarkan mata pelajaran guru
            const teacherSubject = currentUser.subject || '';
            const subjectLKPDTitles = lkpdData
                .filter(l => {
                    const mataPelajaran = l['Mata Pelajaran'] || l['mata_pelajaran'] || l.MataPelajaran || l.Subject || l.subject || '';
                    return mataPelajaran === teacherSubject;
                })
                .map(l => l.Judul || l.judul);

            const relevantProgress = rekapProgresData.filter(record => 
                subjectLKPDTitles.includes(record.LKPD)
            );

            if (relevantProgress.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="text-6xl mb-4">üìä</div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Belum Ada Aktivitas</h3>
                            <p class="text-gray-600">Belum ada siswa yang mengerjakan LKPD untuk mata pelajaran ${teacherSubject}</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Statistik overview
            const totalStudents = new Set(relevantProgress.map(p => p.NISN)).size;
            const totalLKPD = new Set(relevantProgress.map(p => p.LKPD)).size;
            const totalClasses = new Set(relevantProgress.map(p => p.Kelas)).size;
            const latestActivity = relevantProgress.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal))[0];

            // Group by student
            const progressByStudent = {};
            relevantProgress.forEach(p => {
                if (!progressByStudent[p.NISN]) {
                    progressByStudent[p.NISN] = {
                        nama: p.Nama,
                        kelas: p.Kelas,
                        lkpd: [],
                        totalLKPD: 0
                    };
                }
                progressByStudent[p.NISN].lkpd.push({
                    judul: p.LKPD,
                    tanggal: p.Tanggal
                });
                progressByStudent[p.NISN].totalLKPD++;
            });

            container.innerHTML = `
                <!-- Overview Statistics -->
                <div class="col-span-full mb-6">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg p-6">
                        <h3 class="text-xl font-bold mb-4">üìä Overview Progress ${teacherSubject}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold">${totalStudents}</div>
                                <div class="text-sm text-blue-100">Siswa Aktif</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${totalLKPD}</div>
                                <div class="text-sm text-blue-100">LKPD Dikerjakan</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${totalClasses}</div>
                                <div class="text-sm text-blue-100">Kelas Berbeda</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold">${relevantProgress.length}</div>
                                <div class="text-sm text-blue-100">Total Aktivitas</div>
                            </div>
                        </div>
                        ${latestActivity ? `
                            <div class="mt-4 pt-4 border-t border-blue-400">
                                <p class="text-sm text-blue-100">
                                    <strong>Aktivitas Terakhir:</strong> ${latestActivity.Nama} (${latestActivity.NISN}) 
                                    mengerjakan "${latestActivity.LKPD}" pada ${latestActivity.Tanggal}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Student Progress Cards -->
                ${Object.entries(progressByStudent).map(([nisn, data]) => `
                    <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-semibold text-gray-800 text-lg">${data.nama}</h4>
                                <p class="text-sm text-gray-600">NISN: ${nisn}</p>
                            </div>
                            <div class="text-right">
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">${data.kelas}</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">LKPD Dikerjakan:</span>
                                <span class="font-semibold text-lg text-green-600">${data.totalLKPD}</span>
                            </div>
                            
                            <div class="border-t pt-3">
                                <p class="text-xs font-semibold text-gray-700 mb-2">Riwayat LKPD:</p>
                                <div class="space-y-1 max-h-24 overflow-y-auto">
                                    ${data.lkpd.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).map(lkpd => `
                                        <div class="flex justify-between text-xs text-gray-600">
                                            <span class="truncate mr-2">${lkpd.judul}</span>
                                            <span class="text-green-600 whitespace-nowrap">${lkpd.tanggal}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="showStudentDetail('${nisn}', '${data.nama}')" 
                                class="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            üìã Lihat Detail Lengkap
                        </button>
                    </div>
                `).join('')}
            `;
        }

        function showStudentDetail(nisn, nama) {
            // Filter progress untuk siswa ini
            const studentProgress = rekapProgresData.filter(record => record.NISN === nisn);
            
            if (studentProgress.length === 0) {
                showNotification('Tidak ada data progress untuk siswa ini', 'info');
                return;
            }

            // Sort berdasarkan tanggal terbaru
            const sortedProgress = studentProgress.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal));

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b p-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">üìã Detail Progress Siswa</h3>
                                <p class="text-gray-600 font-medium">${nama} (NISN: ${nisn})</p>
                                <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">üìù ${sortedProgress.length} LKPD</span>
                                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded">üè´ ${sortedProgress[0]?.Kelas || '-'}</span>
                                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">üìÖ Terakhir: ${sortedProgress[0]?.Tanggal || '-'}</span>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-500 hover:text-gray-700 text-xl">‚úï</button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">No</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Tanggal</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">LKPD</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Kelas</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold text-gray-700">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedProgress.map((progress, index) => `
                                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-gray-700">${index + 1}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm font-medium text-gray-800">${progress.Tanggal}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-gray-800">${progress.LKPD}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">
                                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${progress.Kelas}</span>
                                            </td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">
                                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">‚úÖ Selesai</span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 flex justify-center">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateProgressDisplay() {
            if (currentUser) {
                if (currentUser.type === 'student') {
                    updateStudentProgress();
                } else {
                    renderTeacherProgress();
                }
            }
        }

        // Element SDK Implementation
        const render = async (config) => {
            document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
            document.getElementById('school-vision').textContent = config.school_vision || defaultConfig.school_vision;
            document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
            document.getElementById('footer-message').textContent = config.footer_message || defaultConfig.footer_message;
            
            const primaryColor = config.primary_color || defaultConfig.primary_color;
            const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
            
            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        };

        const mapToCapabilities = (config) => ({
            recolorables: [
                {
                    get: () => config.primary_color || defaultConfig.primary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    }
                },
                {
                    get: () => config.secondary_color || defaultConfig.secondary_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ secondary_color: value });
                        }
                    }
                },
                {
                    get: () => config.accent_color || defaultConfig.accent_color,
                    set: (value) => {
                        if (window.elementSdk) {
                            window.elementSdk.setConfig({ accent_color: value });
                        }
                    }
                }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
        });

        const mapToEditPanelValues = (config) => new Map([
            ["school_name", config.school_name || defaultConfig.school_name],
            ["school_vision", config.school_vision || defaultConfig.school_vision],
            ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
            ["footer_message", config.footer_message || defaultConfig.footer_message]
        ]);

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error("Failed to initialize data SDK");
                }
            }
            
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    render,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }

            await loadAllData();
        });
    </script><!-- Login Screen -->
  <div id="login-screen" class="min-h-full"><!-- Header -->
   <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-8">
     <div class="text-center">
      <h1 id="school-name" class="text-4xl font-bold mb-2">SMP Negeri 1 Indonesia</h1>
      <p id="school-vision" class="text-xl text-blue-100 mb-4">Mewujudkan Generasi Cerdas, Berkarakter, dan Berdaya Saing Global</p>
      <p id="welcome-message" class="text-lg text-blue-200">Selamat datang di portal pembelajaran digital yang inovatif</p>
     </div>
    </div>
   </header><!-- Login Section -->
   <div class="container mx-auto px-4 py-12">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
     <div class="text-center mb-8">
      <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-3xl">üéì</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Portal Pembelajaran</h2>
      <p class="text-gray-600">Masuk untuk mengakses materi dan LKPD</p>
     </div>
     <form onsubmit="handleLogin(event)" class="space-y-6">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pengguna</label> <select name="userType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">Pilih jenis pengguna</option> <option value="student">Siswa</option> <option value="teacher">Guru</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">ID Pengguna</label> <input type="text" name="identifier" required placeholder="Masukkan NISN (siswa) atau NIP (guru)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div><button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
       <div class="loading-indicator hidden items-center justify-center">
        <div class="loading-spinner mr-2"></div> Memproses...
       </div><span class="login-text">üöÄ Masuk Portal</span> </button>
     </form>
     <div id="login-help" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      <p class="text-sm text-yellow-800"><strong>üí° Bantuan Login:</strong><br>
        ‚Ä¢ Siswa: Gunakan NISN yang terdaftar<br>
        ‚Ä¢ Guru: Gunakan NIP yang terdaftar<br>
        ‚Ä¢ Pastikan data sudah tersedia di Google Sheets</p>
     </div>
     <div class="mt-6 text-center"><button onclick="showDebugInfo()" class="text-sm text-blue-600 hover:text-blue-800 underline"> üîç Debug Info &amp; Status Koneksi </button>
     </div>
    </div>
   </div><!-- Footer -->
   <footer class="bg-gray-800 text-white py-8 mt-12">
    <div class="container mx-auto px-4 text-center">
     <p id="footer-message" class="text-lg mb-4">Merdeka Belajar - Indonesia Maju 2045</p>
     <p class="text-gray-400 text-sm">¬© 2024 Sistem Pembelajaran Digital SMP</p>
    </div>
   </footer>
  </div><!-- Dashboard Screen -->
  <div id="dashboard-screen" class="hidden min-h-full"><!-- Dashboard Header -->
   <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
     <div class="flex justify-between items-center">
      <div>
       <h1 class="text-2xl font-bold">Portal Pembelajaran</h1>
       <p class="text-blue-200">Dashboard Pengguna</p>
      </div>
      <div class="text-right">
       <div class="flex items-center space-x-4">
        <div>
         <p id="user-name" class="font-semibold text-lg">Nama Pengguna</p>
         <p id="user-info" class="text-sm text-blue-200">Info Pengguna</p>
        </div><button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors"> üö™ Logout </button>
       </div>
      </div>
     </div>
    </div>
   </header><!-- Dashboard Content -->
   <div class="container mx-auto px-4 py-8"><!-- Navigation Tabs -->
    <div class="mb-8">
     <div class="border-b border-gray-200">
      <nav class="-mb-px flex space-x-8"><button onclick="showTab('materials')" id="materials-tab" class="tab-button py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600"> üìö Materi Pembelajaran </button> <button onclick="showTab('lkpd')" id="lkpd-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"> üìù LKPD </button> <button onclick="showTab('progress')" id="progress-tab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"> üìä Progress </button>
      </nav>
     </div>
    </div><!-- Tab Contents -->
    <div id="materials-content" class="tab-content">
     <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">üìö Materi Pembelajaran</h2>
      <p class="text-gray-600">Akses materi pembelajaran sesuai dengan kelas dan mata pelajaran Anda</p>
     </div>
     <div id="materials-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-8">
       <div class="loading-spinner mr-2"></div> Memuat materi...
      </div>
     </div>
    </div>
    <div id="lkpd-content" class="tab-content hidden">
     <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">üìù Lembar Kerja Peserta Didik</h2>
      <p class="text-gray-600">Kerjakan LKPD sesuai dengan mata pelajaran dan kelas Anda</p>
     </div>
     <div id="lkpd-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-8">
       <div class="loading-spinner mr-2"></div> Memuat LKPD...
      </div>
     </div>
    </div>
    <div id="progress-content" class="tab-content hidden">
     <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">üìä Progress Pembelajaran</h2>
      <p class="text-gray-600">Pantau kemajuan pembelajaran dan aktivitas Anda</p>
     </div>
     <div id="progress-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div class="loading-indicator flex items-center justify-center py-8">
       <div class="loading-spinner mr-2"></div> Memuat progress...
      </div>
     </div>
    </div>
   </div><!-- Dashboard Footer -->
   <footer class="bg-gray-800 text-white py-6 mt-12">
    <div class="container mx-auto px-4 text-center">
     <p id="footer-message-dashboard" class="text-lg mb-2">Merdeka Belajar - Indonesia Maju 2045</p>
     <p class="text-gray-400 text-sm">¬© 2024 Sistem Pembelajaran Digital SMP</p>
    </div>
   </footer>
  </div>
  <script>
        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active state to selected tab
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98f0db3c115c91b4',t:'MTc2MDU0NzQ1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
