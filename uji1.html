<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal Pembelajaran SMP</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
      <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">Portal Pembelajaran</h1>
      <form id="login-form" class="space-y-4">
        <select id="userType" required class="w-full border rounded-lg p-2">
          <option value="">Pilih Jenis Pengguna</option>
          <option value="student">Siswa</option>
          <option value="teacher">Guru</option>
        </select>
        <input id="identifier" type="text" required placeholder="Masukkan NISN (siswa) atau NIP (guru)" class="w-full border rounded-lg p-2" />
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Masuk</button>
      </form>
      <p id="login-message" class="text-center text-red-600 mt-4"></p>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden min-h-screen">
    <header class="bg-blue-600 text-white py-4">
      <div class="container mx-auto px-4 flex justify-between">
        <div>
          <h2 id="user-name" class="font-bold"></h2>
          <p id="user-role" class="text-sm text-blue-100"></p>
        </div>
        <button id="logout" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg">Logout</button>
      </div>
    </header>

    <main class="container mx-auto px-4 py-8">
      <nav class="flex space-x-2 mb-6">
        <button id="tab-materi" class="tab-btn bg-blue-600 text-white px-4 py-2 rounded-lg">Materi</button>
        <button id="tab-lkpd" class="tab-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">LKPD</button>
      </nav>

      <section id="materi-section">
        <h3 class="text-xl font-bold mb-4">üìò Materi Pembelajaran</h3>
        <div id="materi-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>

      <section id="lkpd-section" class="hidden">
        <h3 class="text-xl font-bold mb-4">üìù Lembar Kerja (LKPD)</h3>
        <div id="lkpd-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>
    </main>
  </div>

  <script>
    const SHEET_ID = "12damNTphrDElg1qsmAWVKoTrfXhDXKa8l660vhTNR8I"; 
    const SHEETS = {
      siswa: "DataSiswa",
      guru: "DataGuru",
      materi: "MateriPelajaran",
      lkpd: "LKPD"
    };

    let siswaData = [];
    let guruData = [];
    let materiData = [];
    let lkpdData = [];
    let currentUser = null;

    async function fetchSheet(sheet) {
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheet}`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const cols = json.table.cols.map(c => c.label);
      return json.table.rows.map(r => {
        const obj = {};
        cols.forEach((c, i) => obj[c] = r.c[i]?.v || "");
        return obj;
      });
    }

    async function loadData() {
      [siswaData, guruData, materiData, lkpdData] = await Promise.all([
        fetchSheet(SHEETS.siswa),
        fetchSheet(SHEETS.guru),
        fetchSheet(SHEETS.materi),
        fetchSheet(SHEETS.lkpd)
      ]);
      console.log("‚úÖ Data Loaded:", {
        siswa: siswaData.length,
        guru: guruData.length,
        materi: materiData.length,
        lkpd: lkpdData.length
      });
    }

    function normalize(str) {
      return (str || "").toString().replace(/\s|\.|-/g, "").toLowerCase();
    }

    function showDashboard(user) {
      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("user-name").textContent = user.Nama;
      document.getElementById("user-role").textContent =
        user.type === "teacher" ? `Guru ${user["Mata Pelajaran"]}` : `Siswa Kelas ${user.Kelas}`;
      if (user.type === "teacher") {
        renderMateriForGuru(user);
        renderLKPDForGuru(user);
      } else {
        renderMateriForSiswa(user);
        renderLKPDForSiswa(user);
      }
    }

    function renderMateriForGuru(user) {
      const mapel = user["Mata Pelajaran"];
      const materi = materiData.filter(m => m["Mata Pelajaran"] === mapel);
      renderMateri(materi);
    }

    function renderMateriForSiswa(user) {
      const kelas = user.Kelas.toString().trim();
      const materi = materiData.filter(m => m.Kelas.toString().trim() === kelas);
      renderMateri(materi);
    }

    function renderMateri(data) {
      const container = document.getElementById("materi-container");
      container.innerHTML = "";
      if (data.length === 0) {
        container.innerHTML = `<p class="text-gray-600">Belum ada materi.</p>`;
        return;
      }
      data.forEach(m => {
        const link = (m.Link || "").trim();
        const isValid = /^https?:\/\//i.test(link);
        const normalized = isValid ? link : `https://${link}`;
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-lg shadow hover:shadow-lg";
        card.innerHTML = `
          <h4 class="font-semibold mb-1">${m.Judul}</h4>
          <p class="text-sm text-gray-600 mb-2">${m.Deskripsi}</p>
          <p class="text-xs text-gray-500 mb-3">${m["Mata Pelajaran"]} ‚Ä¢ Kelas ${m.Kelas}</p>
          <a href="${normalized}" target="_blank"
             class="block text-center py-2 rounded-lg ${isValid ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-300 text-gray-500'}">
             ${isValid ? 'Buka Materi' : 'Link Tidak Tersedia'}
          </a>
        `;
        container.appendChild(card);
      });
    }

    function renderLKPDForGuru(user) {
      const mapel = user["Mata Pelajaran"];
      const data = lkpdData.filter(l => l["Mata Pelajaran"] === mapel);
      renderLKPD(data);
    }

    function renderLKPDForSiswa(user) {
      const kelas = user.Kelas.toString().trim();
      const data = lkpdData.filter(l => l.Kelas.toString().trim() === kelas);
      renderLKPD(data);
    }

    function renderLKPD(data) {
      const container = document.getElementById("lkpd-container");
      container.innerHTML = "";
      if (data.length === 0) {
        container.innerHTML = `<p class="text-gray-600">Belum ada LKPD.</p>`;
        return;
      }
      data.forEach(l => {
        const link = (l.Link || "").trim();
        const isValid = /^https?:\/\//i.test(link);
        const normalized = isValid ? link : `https://${link}`;
        const card = document.createElement("div");
        card.className = "bg-white p-4 rounded-lg shadow hover:shadow-lg";
        card.innerHTML = `
          <h4 class="font-semibold mb-1">${l.Judul}</h4>
          <p class="text-sm text-gray-600 mb-2">${l.Deskripsi}</p>
          <p class="text-xs text-gray-500 mb-3">${l["Mata Pelajaran"]} ‚Ä¢ Kelas ${l.Kelas}</p>
          <a href="${normalized}" target="_blank"
             class="block text-center py-2 rounded-lg ${isValid ? 'bg-orange-600 text-white hover:bg-orange-700' : 'bg-gray-300 text-gray-500'}">
             ${isValid ? 'Kerjakan LKPD' : 'Link Tidak Tersedia'}
          </a>
        `;
        container.appendChild(card);
      });
    }

    async function handleLogin(event) {
      event.preventDefault();
      const type = document.getElementById("userType").value;
      const id = document.getElementById("identifier").value.trim();
      const msg = document.getElementById("login-message");
      msg.textContent = "";

      if (!type || !id) {
        msg.textContent = "Isi semua data dengan benar.";
        return;
      }

      if (type === "teacher") {
        const user = guruData.find(g => normalize(g.NIP) === normalize(id));
        if (user) {
          currentUser = { ...user, type: "teacher" };
          showDashboard(currentUser);
        } else {
          msg.textContent = "NIP tidak ditemukan.";
        }
      } else {
        const user = siswaData.find(s => normalize(s.NISN) === normalize(id));
        if (user) {
          currentUser = { ...user, type: "student" };
          showDashboard(currentUser);
        } else {
          msg.textContent = "NISN tidak ditemukan.";
        }
      }
    }

    // TAB HANDLER
    document.getElementById("tab-materi").addEventListener("click", () => {
      document.getElementById("materi-section").classList.remove("hidden");
      document.getElementById("lkpd-section").classList.add("hidden");
      document.getElementById("tab-materi").classList.add("bg-blue-600", "text-white");
      document.getElementById("tab-lkpd").classList.remove("bg-blue-600", "text-white");
    });

    document.getElementById("tab-lkpd").addEventListener("click", () => {
      document.getElementById("materi-section").classList.add("hidden");
      document.getElementById("lkpd-section").classList.remove("hidden");
      document.getElementById("tab-lkpd").classList.add("bg-blue-600", "text-white");
      document.getElementById("tab-materi").classList.remove("bg-blue-600", "text-white");
    });

    document.getElementById("logout").addEventListener("click", () => location.reload());
    document.getElementById("login-form").addEventListener("submit", handleLogin);

    loadData();
  </script>
</body>
</html>
